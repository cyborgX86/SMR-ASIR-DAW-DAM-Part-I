<!doctype html>

<!--[if lt IE 7 ]> <html class="ie ie6 no-js" lang="ca"> <![endif]-->
<!--[if IE 7 ]>    <html class="ie ie7 no-js" lang="ca"> <![endif]-->
<!--[if IE 8 ]>    <html class="ie ie8 no-js" lang="ca"> <![endif]-->
<!--[if IE 9 ]>    <html class="ie ie9 no-js" lang="ca"> <![endif]-->
<!--[if gt IE 9]><!--><html class="no-js" lang="ca"><!--<![endif]-->
<!-- the "no-js" class is for Modernizr. -->

<head id="www-sitename-com" data-template-set="html5-reset">

	<meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html">
        
	<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame -->
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	
	<title>Serveis de Xarxa i Internet</title>
	
<!-- <meta name="title" content=""> --> 
	<meta name="description" content="">
	<!-- Google will often use this as its description of your page/site. Make it good. -->
	
	<meta name="google-site-verification" content="">
	<!-- Speaking of Google, don't forget to set your site up: http://google.com/webmasters -->
	
	<meta name="author" content="Institut Obert de Catalunya">
	<meta name="Copyright" content="Copyright Institut Obert de Catalunya 2011. All Rights Reserved.">

	<!-- Dublin Core Metadata : http://dublincore.org/ -->
	<meta name="DC.title" content="Serveis de Xarxa i Internet">
	<meta name="DC.subject" content="Informàtica i comunicacions">
	<meta name="DC.creator" content="Institut Obert de Catalunya">
	
	<!--  Mobile Viewport Fix
	j.mp/mobileviewport & davidbcalhoun.com/2010/viewport-metatag 
	device-width : Occupy full width of the screen in its current orientation
	initial-scale = 1.0 retains dimensions instead of zooming out if page height > device height
	maximum-scale = 1.0 retains dimensions instead of zooming in if page width < device width
	-->
	<!-- Uncomment to use � use thoughtfully!
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
	-->

	<link rel="shortcut icon" href="../../../img/favicon.ico">
	<!-- This is the traditional favicon.
		 - size: 16x16 or 32x32
		 - transparency is OK
		 - see wikipedia for info on browser support: http://mky.be/favicon/ -->
		 
	<link rel="apple-touch-icon" href="../../../img/apple-touch-icon.png">
	<!-- The is the icon for iOS's Web Clip.
		 - size: 57x57 for older iPhones, 72x72 for iPads, 114x114 for iPhone4's retina display (IMHO, just go ahead and use the biggest one)
		 - To prevent iOS from applying its styles to the icon name it thusly: apple-touch-icon-precomposed.png
		 - Transparency is not recommended (iOS will put a black BG behind the icon) -->
	
	<!-- CSS: screen, mobile & print are all in the same file -->
	<link rel="stylesheet" href="../../../_/css/style.css">

	<!-- CSS: jQuery UI -->
	<link rel="stylesheet" href="../../../_/css/jquery-ui.css">
	
	<!-- all our JS is at the bottom of the page, except for Modernizr. -->
	<script src="../../../_/js/modernizr-1.7.min.js"></script>
	<script src="../../../_/js/Hyphenator.js" type="text/javascript"></script>
	<script type="text/javascript">
	   Hyphenator.config({
		minwordlength : 4
	   });
	   Hyphenator.run();
	</script>
    <script src="../../../_/js/build.js" type="text/javascript"></script>
</head>

<body class="style-newspaper">

<div class="wrapper"><!-- not needed? up to you: http://camendesign.com/code/developpeurs_sans_frontieres -->

	<header id="header">
		<div class="head"><a href="http://ioc.gencat.cat"><img src="../../../img/logo.png" alt="Institut Obert de Catalunya"/></a><a href="http://creativecommons.org/licenses/by-nc-sa/3.0/es/deed.ca"><img src="../../../img/license.png" alt="Llic&egrave;ncia" class="license"/></a></div>
		<div class="headdocument"><a href="../../../index.html">Serveis de Xarxa i Internet</a></div>
        <div id="search" class="search" name="search">
         <form id="frmsearch" action="../../../search.html" method="get">
          <input type="text" name="q"/>
        </form>
        </div>
	</header>
   <div id="upbutton" class="upbutton" style="display:none;"><img src="../../../img/uparrow.png" alt="Pujar a l'inici de p&agrave;gina"/></div>
   <aside id="aside">
    <div id="menu">
      <ul>
       <li name="toc"><div><img src="../../../img/toc.png" alt="&Iacute;ndex"/></div></li>
       <li name="settings"><div><img src="../../../img/settings.png" alt="Configuraci&oacute;"/></div></li>
       <li name="printer"><div><img src="../../../img/printer.png" alt="Imprimir"/></div></li>
       <li name="favorites"><div><img src="../../../img/favorites.png" alt="Favorits"/></div></li>
       <li name="help_icon" class="help_icon"><div><img src="../../../img/help_icon.png" alt="Ajuda"/></div></li>
      </ul>
     </div>
   </aside>
   <div id="sidebar-hide" name="sidebar-hide"><img src="../../../img/arrows.png"/></div>
   <section>
     <div id="toc" class="hidden">
      <div class="menucontent">
        <ul>
        <li id="u3" class="parentnode"><p><a class="unit" href="../../../WebContent/u3/introduccio.html">3. Correu electrònic i missatgeria</a></p><ul class="expander"><li id="u3introduccio"><a href="../../../WebContent/u3/introduccio.html">Introducció</a></li><li id="u3resum"><a href="../../../WebContent/u3/resum.html">Resum</a></li><li id="u3resultats"><a href="../../../WebContent/u3/resultats.html">Resultats d'aprenentatge</a></li><li id="u3referencies"><a href="../../../WebContent/u3/referencies.html">Referències</a></li><li id="u3a1" class="tocsection"><p id='u3a1continguts'><a class="section" href="../../../WebContent/u3/a1/continguts.html">Instal·lació i administració del servei de correu electrònic</a><span class="buttonexp"></span></p><ul><li id="u3a1activitats"><a href="../../../WebContent/u3/a1/activitats.html">Activitats</a></li><li id="u3a1exercicis"><a href="../../../WebContent/u3/a1/exercicis.html">Exercicis</a></li><li id="u3a1annexos"><a href="../../../WebContent/u3/a1/annexos.html">Annexos</a></li></ul></li><div data-parent-id='u3a1' class='tocssection hidden'><div class="toc"><ul><li><a href="../../../WebContent/u3/a1/continguts.html#protocols_de_correu_electronic">Protocols de correu electrònic</a></li><li><a href="../../../WebContent/u3/a1/continguts.html#instal_lacio_d_un_servidor">Instal·lació d'un servidor</a></li><li><a href="../../../WebContent/u3/a1/continguts.html#acces_remot_al_correu">Accés remot al correu</a></li><li><a href="../../../WebContent/u3/a1/continguts.html#correu_encriptat_i_signat">Correu encriptat i signat</a></li><li><a href="../../../WebContent/u3/a1/continguts.html#servidor_de_correu_segur">Servidor de correu segur</a></li></ul></div></div><li id="u3a2" class="tocsection"><p id='u3a2continguts'><a class="section" href="../../../WebContent/u3/a2/continguts.html">Instal·lació i administració de serveis de missatgeria instantània, notícies i llistes de distribuci...</a><span class="buttonexp"></span></p><ul><li id="u3a2activitats"><a href="../../../WebContent/u3/a2/activitats.html">Activitats</a></li><li id="u3a2exercicis"><a href="../../../WebContent/u3/a2/exercicis.html">Exercicis</a></li><li id="u3a2annexos"><a href="../../../WebContent/u3/a2/annexos.html">Annexos</a></li></ul></li><div data-parent-id='u3a2' class='tocssection hidden'><div class="toc"><ul><li><a href="../../../WebContent/u3/a2/continguts.html#missatgeria_instantania">Missatgeria instantània</a></li><li><a href="../../../WebContent/u3/a2/continguts.html#llistes_de_distribucio">Llistes de distribució</a></li><li><a href="../../../WebContent/u3/a2/continguts.html#servei_de_noticies">Servei de notícies</a></li></ul></div></div></ul></li><li id="" class="indexnode"><p><a href="../../../index.html">Anar a l&#39;&iacute;ndex general</a></p></li>
        </ul>
      </div>
    </div>
   </section>
   <section>
   <div id="settings" class="hidden">
    <div class="menucontent">
     <div class="allsettings">
     <div class="settings">
      <label>Font i Color</label>
		<div class="setting-option">
	        <ul class="fontBackground">
				<li id="style-newspaper" title="Newspaper" class="appearance-style-newspaper"><span>Newspaper</span></li>
                <li id="style-novel" title="Novel" class="appearance-style-novel"><span>Novel</span></li>
                <li id="style-ebook" title="eBook" class="appearance-style-ebook"><span>eBook</span></li>
				<li id="style-inverse" title="Inverse" class="appearance-style-inverse active"><span>Inverse</span></li>
				<li id="style-athelas" title="Athelas" class="appearance-style-athelas"><span>Athelas</span></li>
			</ul>
		</div>
     </div>
	<div class="settings">
      <label>Amplada</label>
		<div class="setting-option">
	        <div id="slider-width"></div>
		</div>
     </div>
     <div class="settings">
      <label>Mida de la font</label>
		<div class="setting-option">
	        <div id="slider-font"></div>
		</div>
     </div>
     <div class="settings">
      <label>Mida de la font</label>
	  <div class="setting-option">
       <form action="" class="sett-options">
		<ul>
		    <li><input type="checkbox" id="secondary-content" /><label for="secondary-content">Mostra recursos complementaris</label></li>
		    <li><input type="checkbox" id="main-images" /><label for="main-images">Mostra imatges</label></li>
		    <li><input type="checkbox" id="text-alignment" /><label for="text-alignment">Text justificat</label></li>
			<li><input type="checkbox" id="text-hyphen" /><label for="text-hyphen">Partici&oacute; sil·l&agrave;bica</label></li>
		</ul>
       </form>
	  </div>
     </div>
     </div>
    </div>
   </div>
   </section>
 <section>
 <div id="favorites" class="hidden"></div>
 </section>   
 <div id="bridge" class="hidden"></div>
 <div id="help" class="hidden">
  <div class="helptitle">Dreceres del teclat<hr></div>
  <div class="helpsection"><span>General</span>
   <ul>
    <li><span class="shortcut">g</span>: Anar al men&uacute; de navegaci&oacute;</li>
    <li><span class="shortcut">o</span>: Anar a opcions</li>
    <li><span class="shortcut">s</span>: Guardar la p&agrave;gina actual a favorits</li>
    <li><span class="shortcut">p</span>: Imprimir la p&agrave;gina actual</li>
    <li><span class="shortcut">?</span>: Mostrar/Ocultar l&#39;ajuda</li>
   </ul>
  </div>
  <div class="helpsection"><span>Navegaci&oacute;</span>
   <ul>
    <li><span class="shortcut">i</span>: Anar a l&#39;&iacute;ndex general</li>
    <li><span class="shortcut">t</span>: Anar a l&#39;inici de p&agrave;gina</li>
    <li><span class="shortcut">b</span>: Anar al final de p&agrave;gina</li>
    <li><span class="shortcut">j</span>: Anar cap endavant dintre la p&agrave;gina</li>
    <li><span class="shortcut">k</span>: Anar cap enrere dintre la p&agrave;gina</li>
    <li><span class="shortcut">h</span>: Anar a la p&agrave;gina anterior:</li>
    <li><span class="shortcut">l</span>: Anar a la p&agrave;gina seg&uuml;ent:</li>
   </ul>
   </div>
 </div>
 <div id="favcounter" name="favcounter" class="hidden"><span></span></div>
 <div id="navmenu" class="navmenu"><ul class="webnav"><li><a href="../../../index.html" title="Anar a l&#39;&iacute;ndex general">Inici</a></li><li><a href="../introduccio.html">Correu electrònic i missatgeria</a></li><li><a href="continguts.html">Instal·lació i administració del servei de correu electrònic</a></li><li>Activitats</li></ul></div>
	<div id="content" lang="ca" class="hyphenate text">
     <article lang="ca" class="sheet">
        <h1><a id="activitats"> Activitats </a></h1>
    	
<h2><a id="quota_de_mercat_dels_servidors_de_correu" >Quota de mercat dels servidors de correu</a></h2>
<div class="level2">

<p>
L’objectiu de l’activitat és conèixer la quota de mercat dels servidors de correu.
</p>

<p>
Esbrineu la quota de mercat dels principals servidors de correu i identifiqueu clarament amb quins paràmetres s’ha mesurat.
</p>

<p>
<form action=""><div class="solution ioccontent">
<p>
Solució oberta.
</p>

<p>
No és el mateix tenir un servidor de correu amb 100.000 usuaris que tenir-ne tres amb 1.000 usuaris cadascun. Per tant, el concepte de quota de mercat és força elàstic. Algunes dades són difícils d’obtenir (algunes empreses no volen revelar segons quines dades). Aquestes estadístiques sempre s’han de contextualitzar.
</p>

<p>
Al web <a href="http://www.securityspace.com" class="urlextern" title="http://www.securityspace.com"  rel="nofollow">Security Space</a> podem trobar diferents informes sobre estadístiques d’ús de programari (apartat <em>Research Reports</em>). En concret, teniu el que fa referència a l’ús dels <a href="http://www.securityspace.com/s_survey/data/man.201908/mxsurvey.html" class="urlextern" title="http://www.securityspace.com/s_survey/data/man.201908/mxsurvey.html"  rel="nofollow">servidors de correu</a>.
</p>

<p>
Aquesta estadística s’ha fet mirant tots els registres MX públics del servei <acronym title="Domain Name System">DNS</acronym>. Els tres més usats són:
</p>
<ol>
<li class="level1"><div class="li"> Exim</div>
</li>
<li class="level1"><div class="li"> Postfix</div>
</li>
<li class="level1"><div class="li"> Sendmail</div>
</li>
</ol>

<p>
S’observa també la seva evolució al llarg dels anys. Sendmail va ser un dels primers a tenir molta popularitat (també és el més antic dels tres, de l’any 1983). Exim (1995) i Postfix (1998) han tingut una evolució força paral·lela, si bé el primer sempre ha tingut més quota de mercat.
</p>
</div><input class="btn_solution3" type="button" value="Mostra"></input></form>
</p>

</div>

<h2><a id="servidor_de_correu_sendmail" >Servidor de correu Sendmail</a></h2>
<div class="level2">

<p>
L’objectiu d’aquesta activitat és aprendre a instal·lar i configurar el servidor SMTP Sendmail i el servidor IMAP Courier. 
</p>

<p>
Sendmail és un dels diversos agents de transport de correu (MTA, <em>Mail Transfer Agent</em>) de programari lliure que permet l’encaminament i l’enviament de correus electrònics a través d’internet amb el protocol SMTP (<em>Simple Mail Transfer Protocol</em>).
</p>

<p>
Realitzeu les següents tasques:
</p>
<ol>
<li class="level1"><div class="li"> Instal·leu Sendmail en el sistema operatiu Linux.</div>
</li>
<li class="level1"><div class="li"> Configureu el programari Sendmail. </div>
</li>
<li class="level1"><div class="li"> Realitzeu proves amb el servidor de correu per tal de verificar l’enviament de correus.</div>
</li>
<li class="level1"><div class="li"> Instal·leu i configureu el protocol IMAP (<em>Internet Message Access Protocol</em>) amb el programari Courier per tal de permetre l’accés a la bústia de correu de forma remota (MDA, <em>Mail Delivery Agent</em>).</div>
</li>
<li class="level1"><div class="li"> Encripteu les comunicacions per proveir seguretat al servei de correu electrònic.</div>
</li>
</ol>

<p>
<form action=""><div class="solution ioccontent">
<p>
<strong>1. Instal·lació del servidor Sendmail</strong>
</p>

<p>
Per instal·lar el programari, accedim al terminal i executem:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install sendmail</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">Els paquets següents s'han instal·lat automàticament i ja no seran necessaris:</div></li><li class="li1"><div class="de1">  apache2-bin apache2-data apache2-utils default-mysql-server galera-3 libaio1 libapache2-mod-php7.0 libapr1 libaprutil1 libaprutil1-dbd-sqlite3 libaprutil1-ldap</div></li><li class="li1"><div class="de1">  libcgi-fast-perl libcgi-pm-perl libconfig-inifiles-perl libdbd-mysql-perl libdbi-perl libfcgi-perl libhtml-template-perl libjemalloc1 libmariadbclient18 libreadline5</div></li><li class="li1"><div class="de1">  libterm-readkey-perl mariadb-client-10.1 mariadb-client-core-10.1 mariadb-common mariadb-server-10.1 mariadb-server-core-10.1 mysql-common php-common php7.0 php7.0-cli</div></li><li class="li1"><div class="de1">  php7.0-common php7.0-json php7.0-mysql php7.0-opcache php7.0-readline rsync socat</div></li><li class="li1"><div class="de1">Empreu «sudo apt autoremove» per a suprimir-los.</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  liblockfile1 lockfile-progs m4 procmail sendmail-base sendmail-bin sendmail-cf sensible-mda</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  m4-doc sendmail-doc rmail logcheck resolvconf sasl2-bin</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  liblockfile1 lockfile-progs m4 procmail sendmail sendmail-base sendmail-bin sendmail-cf sensible-mda</div></li><li class="li1"><div class="de1">0 actualitzats, 9 nous a instal·lar, 0 a suprimir i 316 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 2178 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 4848 kB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
En un moment de la instal·lació es generen els certificats TLS/SSL per encriptar les comunicacions i s’indica com activar-ho (es realitzarà més endavant):
</p>
<pre class="code">Creating/Updating SSL(for TLS) information
Creating /etc/mail/tls/starttls.m4...
Creating SSL certificates for sendmail.
Generating DSA parameters, 2048 bit long prime
This could take some time
....+......+++++++++++++++++++++++++++++++++++++++++++++++++++*
...................+................+.+.................+.....................+............+.............+...........+....+..............+............+.......................................+...+........+.+.....+....+...+...+.............+..+................+..+.......+.+.+.+..+...+.+........+.....+..................+......+................+................+..+...........+.+..........+..........+.....+.......+..................+............................................................+.....+.+......+...+....+...+..............+..+...........+..................+++++++++++++++++++++++++++++++++++++++++++++++++++*
Generating RSA private key, 2048 bit long modulus
.............+++
................+++
e is 65537 (0x010001)

*** *** *** WARNING *** WARNING *** WARNING *** WARNING *** *** ***

Everything you need to support STARTTLS (encrypted mail transmission
and user authentication via certificates) is installed and configured
but is *NOT* being used.

To enable sendmail to use STARTTLS, you need to:
1) Add this line to /etc/mail/sendmail.mc and optionally
   to /etc/mail/submit.mc:
  include(`/etc/mail/tls/starttls.m4&#039;)dnl
2) Run sendmailconfig
3) Restart sendmail</pre>

<p>
El programari Sendmail en la distribució de Linux està estructurat en diversos paquets de forma jeràrquica. Les dependències del paquet principal són:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-cache depends sendmail</div></li><li class="li1"><div class="de1">sendmail</div></li><li class="li1"><div class="de1">  Depèn: sendmail-base</div></li><li class="li1"><div class="de1">  Depèn: sendmail-bin</div></li><li class="li1"><div class="de1">  Depèn: sendmail-cf</div></li><li class="li1"><div class="de1">  Depèn: sensible-mda</div></li><li class="li1"><div class="de1">  Suggereix: sendmail-doc</div></li><li class="li1"><div class="de1">  Suggereix: rmail</div></li></ol></pre>

<p>
Per trobar la configuració del servei cerquem la paraula <em>init.d</em> als diferents paquets:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># dpkg -L sendmail | grep init.d</div></li><li class="li1"><div class="de1"># dpkg -L sendmail-base | grep init.d</div></li><li class="li1"><div class="de1"># dpkg -L sendmail-bin | grep init.d</div></li><li class="li1"><div class="de1">/etc/init.d</div></li><li class="li1"><div class="de1">/etc/init.d/sendmail</div></li></ol></pre>

<p>
Els arxius per a la configuració del servei es troben al paquet <em>sendmail-bin</em>.
</p>

<p>
<strong>2. Configuració del servidor Sendmail</strong>
</p>

<p>
Per tal de configurar el servidor utilitzarem la comanda <em>sendmailconfig</em> des del terminal amb les opcions que ens proposa per defecte.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># sendmailconfig</div></li><li class="li1"><div class="de1">Configure sendmail with the existing /etc/mail/sendmail.conf? [Y] </div></li><li class="li1"><div class="de1">Reading configuration from /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Validating configuration.</div></li><li class="li1"><div class="de1">Writing configuration to /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Writing /etc/cron.d/sendmail.</div></li><li class="li1"><div class="de1">Configure sendmail with the existing /etc/mail/sendmail.mc? [Y] </div></li><li class="li1"><div class="de1">Updating sendmail environment ...</div></li><li class="li1"><div class="de1">Reading configuration from /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Validating configuration.</div></li><li class="li1"><div class="de1">Writing configuration to /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Writing /etc/cron.d/sendmail.</div></li><li class="li1"><div class="de1">Reading configuration from /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Validating configuration.</div></li><li class="li1"><div class="de1">Writing configuration to /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Writing /etc/cron.d/sendmail.</div></li><li class="li1"><div class="de1">Could not open /etc/mail/databases(No such file or directory), creating it.</div></li><li class="li1"><div class="de1">Reading configuration from /etc/mail/sendmail.conf.</div></li><li class="li1"><div class="de1">Validating configuration.</div></li><li class="li1"><div class="de1">Creating /etc/mail/databases...</div></li><li class="li1"><div class="de1">...</div></li><li class="li1"><div class="de1">etc/mail/aliases: 0 aliases, longest 0 bytes, 0 bytes total</div></li><li class="li1"><div class="de1">Reload the running sendmail now with the new configuration? [Y] Reloading sendmail ...</div></li></ol></pre>

<p>
Pot trigar una estona. D’aquesta manera es configuren diferents fitxers que es troben a <em>/etc/mail</em>.
</p>

<p>
Si comprovem l’estat del servei, aquest ja es troba actiu:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># service sendmail status</div></li><li class="li1"><div class="de1">● sendmail.service - LSB: powerful, efficient, and scalable Mail Transport Agent</div></li><li class="li1"><div class="de1">   Loaded: loaded (/etc/init.d/sendmail; generated; vendor preset: enabled)</div></li><li class="li1"><div class="de1">   Active: active (running) since Wed 2019-09-25 19:06:14 CEST; 5s ago</div></li><li class="li1"><div class="de1">     Docs: man:systemd-sysv-generator(8)</div></li><li class="li1"><div class="de1">  Process: 1776 ExecStop=/etc/init.d/sendmail stop (code=exited, status=0/SUCCESS)</div></li><li class="li1"><div class="de1">  Process: 1810 ExecStart=/etc/init.d/sendmail start (code=exited, status=0/SUCCESS)</div></li><li class="li1"><div class="de1">    Tasks: 1 (limit: 4915)</div></li><li class="li1"><div class="de1">   CGroup: /system.slice/sendmail.service</div></li><li class="li1"><div class="de1">           └─1859 sendmail: MTA: accepting connections</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">set 25 19:06:12 server.ioc.cat systemd[1]: Starting LSB: powerful, efficient, and scalable Mail Transport Agent...</div></li><li class="li1"><div class="de1">set 25 19:06:12 server.ioc.cat su[1842]: Successful su for smmsp by root</div></li><li class="li1"><div class="de1">set 25 19:06:12 server.ioc.cat su[1842]: + ??? root:smmsp</div></li><li class="li1"><div class="de1">set 25 19:06:12 server.ioc.cat su[1842]: pam_unix(su:session): session opened for user smmsp by (uid=0)</div></li><li class="li1"><div class="de1">set 25 19:06:13 server.ioc.cat sm-mta[1853]: gethostbyaddr(10.0.2.15) failed: 2</div></li><li class="li1"><div class="de1">set 25 19:06:13 server.ioc.cat sm-mta[1859]: starting daemon (8.15.2): SMTP+queueing@00:10:00</div></li><li class="li1"><div class="de1">set 25 19:06:14 server.ioc.cat sendmail[1810]: Starting Mail Transport Agent (MTA): sendmail.</div></li><li class="li1"><div class="de1">set 25 19:06:14 server.ioc.cat systemd[1]: Started LSB: powerful, efficient, and scalable Mail Transport Agent.</div></li></ol></pre>

<p>
Amb la comanda <em>nmap</em> comprovem quin ports ha obert el servidor:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># nmap localhost</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Starting Nmap 7.40 ( https://nmap.org ) at 2019-09-25 19:08 CEST</div></li><li class="li1"><div class="de1">Nmap scan report for localhost (127.0.0.1)</div></li><li class="li1"><div class="de1">Host is up (0.000011s latency).</div></li><li class="li1"><div class="de1">Other addresses for localhost (not scanned): ::1</div></li><li class="li1"><div class="de1">Not shown: 997 closed ports</div></li><li class="li1"><div class="de1">PORT     STATE SERVICE</div></li><li class="li1"><div class="de1">25/tcp   open  smtp</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Nmap done: 1 IP address (1 host up) scanned in 1.71 seconds</div></li></ol></pre>

<p>
S’ha obert el port 25, que és el que correspon al port del protocol SMTP.
</p>

<p>
<strong>3. Proves amb el servidor de correu</strong>
</p>

<p>
Instal·lem el paquet <em>mailutils</em> per poder usar la comanda <em>mail</em>. Aquesta és una comanda molt senzilla que permet enviar correus electrònics des de la línia de comanda i, per tant, verificar el funcionament més bàsic del servidor. Aquesta comanda es troba al paquet <em>mailutils</em>. 
</p>

<p>
Per tal d’enviar un correu des del nostre usuari a un altre usuari del sistema operatiu:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">apt-get install mailutils</div></li><li class="li1"><div class="de1">echo &quot;Correu de prova&quot; | mail -s &quot;PROVA&quot; usuari@server.ioc.cat</div></li></ol></pre>

<p>
Per annexar fitxers:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">echo &quot;Annex de prova&quot; &gt; annex.txt</div></li><li class="li1"><div class="de1">echo &quot;Correu de prova&quot; | mail -s &quot;PROVA&quot; usuari@server.ioc.cat -A annex.txt</div></li></ol></pre>

<p>
Per a més informació sobre el paràmetres de la comanda, es pot consultar el manual:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">man mail</div></li></ol></pre>

<p>
Els correus per defecte a Sendmail s’emmagatzemen a <em>/var/mail</em> en forma d’un fitxer per a cada usuari.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># ls /var/mail -alis</div></li><li class="li1"><div class="de1">total 16</div></li><li class="li1"><div class="de1">  246 4 drwxrwsrwt  2 root   mail 4096 set 25 19:20 .</div></li><li class="li1"><div class="de1">   12 4 drwxr-xr-x 12 root   root 4096 jul 10 15:56 ..</div></li><li class="li1"><div class="de1">  134 4 -rw-------  1 root   mail 2297 set 25 19:19 root</div></li><li class="li1"><div class="de1">31796 4 -rw-rw----  1 usuari mail  627 set 25 19:20 usuari</div></li><li class="li1"><div class="de1"># cat /var/mail/usuari </div></li><li class="li1"><div class="de1">From root@server.ioc.cat  Wed Sep 25 19:20:11 2019</div></li><li class="li1"><div class="de1">Return-Path: &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Received: from server.ioc.cat (localhost [127.0.0.1])</div></li><li class="li1"><div class="de1">	by server.ioc.cat (8.15.2/8.15.2/Debian-8) with ESMTP id x8PHKATb002455</div></li><li class="li1"><div class="de1">	for &lt;usuari@server.ioc.cat&gt;; Wed, 25 Sep 2019 19:20:10 +0200</div></li><li class="li1"><div class="de1">Received: (from root@localhost)</div></li><li class="li1"><div class="de1">	by server.ioc.cat (8.15.2/8.15.2/Submit) id x8PHKAY5002454;</div></li><li class="li1"><div class="de1">	Wed, 25 Sep 2019 19:20:10 +0200</div></li><li class="li1"><div class="de1">Date: Wed, 25 Sep 2019 19:20:10 +0200</div></li><li class="li1"><div class="de1">From: root &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Message-Id: &lt;201909251720.x8PHKAY5002454@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Subject: PROVA</div></li><li class="li1"><div class="de1">To: &lt;usuari@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">X-Mailer: mail (GNU Mailutils 3.1.1)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Correu de prova</div></li></ol></pre>

<p>
Per poder enviar i llegir els correus d’una forma més agradable es pot utilitzar un client de correu de text. En aquest cas, utilitzem el programari <strong>Mutt</strong>.
</p>

<p>
Per instal·lar Mutt:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install mutt</div></li></ol></pre>

<p>
Per iniciar el programa (s’autoconfigura al principi):
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># mutt</div></li></ol></pre>

<p>
Podem veure la llista de correus que hem rebut:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt1.png" alt="" /></div>

</p>

<p>
Si entrem en un, podem veure el missatge:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt2.png" alt="" /></div>

</p>

<p>
Amb la tecla <em>v</em> veiem els fitxers annexats:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt3.png" alt="" /></div>

</p>

<p>
I podem seleccionar el fitxer annexat:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt4.png" alt="" /></div>

</p>

<p>
Capturem amb l’<em>snifer</em> <strong>Wireshark</strong> l’enviament d’un correu electrònic
</p>

<p>
<div class="imgelem">
<img src="../media/wireshark1.png" alt="" /></div>

</p>

<p>
Si anem al primer paquet i cliquem el botó dret, <em>Follow</em>, <em>TCP Stream</em>, podem veure tot el diàleg:
</p>

<p>
<div class="imgelem">
<img src="../media/wireshark2.png" alt="" /></div>

</p>

<p>
<strong>4. Accés remot al correu amb IMAP mitjançant el programari Courier</strong>
</p>

<p>
Courier és un altre programari de correu de codi obert. Conté de forma separada la part de transport (MTA) de la part de lliurament (MDA, <em>Mail Delivery Agent</em>). Ens interessa aquesta última on hi ha el servei IMAP. Aquest es pot configurar de forma individual per tal de treballar amb altres servidors de correu, com Sendmail, Exim i Postfix.
</p>

<p>
Cerquem el paquet a instal·lar amb <em>apt-cache</em>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-cache search courier | grep imap</div></li><li class="li1"><div class="de1">courier-imap - Courier mail server - IMAP server</div></li><li class="li1"><div class="de1">courier-imap-ssl - Courier mail server - IMAP over TLS [transitional]</div></li><li class="li1"><div class="de1">imapcopy - IMAP backup, copy and migration tool</div></li></ol></pre>

<p>
Instal·lem el programari courier per a IMAP amb les opcions per defecte:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install courier-imap</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">El paquets següents s'han instal·lat automàticament i ja no serà necessaris:</div></li><li class="li1"><div class="de1">  apache2-bin apache2-data apache2-utils default-mysql-server galera-3 libaio1 libapache2-mod-php7.0 libapr1 libaprutil1</div></li><li class="li1"><div class="de1">  libaprutil1-dbd-sqlite3 libaprutil1-ldap libconfig-inifiles-perl libdbd-mysql-perl libdbi-perl libhtml-template-perl</div></li><li class="li1"><div class="de1">  libjemalloc1 libreadline5 libterm-readkey-perl mariadb-client-10.1 mariadb-client-core-10.1 mariadb-common</div></li><li class="li1"><div class="de1">  mariadb-server-10.1 mariadb-server-core-10.1 php-common php7.0 php7.0-cli php7.0-common php7.0-json php7.0-mysql</div></li><li class="li1"><div class="de1">  php7.0-opcache php7.0-readline rsync socat</div></li><li class="li1"><div class="de1">Empreu «apt autoremove» per suprimir-los.</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  courier-authdaemon courier-authlib courier-authlib-userdb courier-base expect gnutls-bin libcourier-unicode1 libfam0</div></li><li class="li1"><div class="de1">  libgnutls-dane0 libgnutls30 libopts25 libtcl8.6 libtk8.6 libunbound2 tcl-expect tcl8.6 tk8.6</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  courier-doc fam dns-root-data tcl-tclreadline</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  courier-authdaemon courier-authlib courier-authlib-userdb courier-base courier-imap expect gnutls-bin libcourier-unicode1</div></li><li class="li1"><div class="de1">  libfam0 libgnutls-dane0 libopts25 libtcl8.6 libtk8.6 libunbound2 tcl-expect tcl8.6 tk8.6</div></li><li class="li1"><div class="de1">S'actualitzaran els paquets següents:</div></li><li class="li1"><div class="de1">  libgnutls30</div></li><li class="li1"><div class="de1">1 actualitzats, 17 nous a instal·lar, 0 a suprimir i 311 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 5078 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 12,3 MB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
Un cop instal·lat, tornem a executar <em>nmap</em> per veure quins ports hi ha oberts. Aquest cop amb els paràmetres -A i -T4 que ens proporcionaran més informació, com el programari que implementa els protocols i la seva versió.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># nmap -A -T4 localhost</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Starting Nmap 7.40 ( https://nmap.org ) at 2019-09-26 17:24 CEST</div></li><li class="li1"><div class="de1">Nmap scan report for localhost (127.0.0.1)</div></li><li class="li1"><div class="de1">Host is up (0.000046s latency).</div></li><li class="li1"><div class="de1">Other addresses for localhost (not scanned): ::1</div></li><li class="li1"><div class="de1">Not shown: 996 closed ports</div></li><li class="li1"><div class="de1">PORT     STATE SERVICE VERSION</div></li><li class="li1"><div class="de1">25/tcp   open  smtp    Sendmail 8.15.2/8.15.2/Debian-8</div></li><li class="li1"><div class="de1">| smtp-commands: server.ioc.cat Hello localhost [127.0.0.1], pleased to meet you, ENHANCEDSTATUSCODES, PIPELINING, EXPN, VERB, 8BITMIME, SIZE, DSN, ETRN, AUTH DIGEST-MD5 CRAM-MD5, STARTTLS, DELIVERBY, HELP, </div></li><li class="li1"><div class="de1">|_ 2.0.0 This is sendmail version 8.15.2 2.0.0 Topics: 2.0.0 HELO EHLO MAIL RCPT DATA 2.0.0 RSET NOOP QUIT HELP VRFY 2.0.0 EXPN VERB ETRN DSN AUTH 2.0.0 STARTTLS 2.0.0 For more info use &quot;HELP &lt;topic&gt;&quot;. 2.0.0 To report bugs in the implementation see 2.0.0 http://www.sendmail.org/email-addresses.html 2.0.0 For local information send email to Postmaster at your site. 2.0.0 End of HELP info </div></li><li class="li1"><div class="de1">| ssl-cert: Subject: commonName=debian/organizationName=Sendmail</div></li><li class="li1"><div class="de1">| Not valid before: 2019-09-25T16:48:39</div></li><li class="li1"><div class="de1">|_Not valid after:  2029-09-22T16:48:39</div></li><li class="li1"><div class="de1">|_ssl-date: ERROR: Script execution failed (use -d to debug)</div></li><li class="li1"><div class="de1">143/tcp  open  imap    Courier Imapd (released 2016)</div></li><li class="li1"><div class="de1">|_imap-capabilities: completed STARTTLSA0001 THREAD=REFERENCES ACL2=UNION ACL IMAP4rev1 SORT CAPABILITY UIDPLUS CHILDREN OK QUOTA THREAD=ORDEREDSUBJECT IDLE NAMESPACE</div></li><li class="li1"><div class="de1">| ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US</div></li><li class="li1"><div class="de1">| Subject Alternative Name: email:postmaster@example.com</div></li><li class="li1"><div class="de1">| Not valid before: 2019-09-26T04:08:11</div></li><li class="li1"><div class="de1">|_Not valid after:  2020-09-25T04:08:11</div></li><li class="li1"><div class="de1">|_ssl-date: 2019-09-26T15:23:50+00:00; -17s from scanner time.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Host script results:</div></li><li class="li1"><div class="de1">|_clock-skew: mean: -17s, deviation: 0s, median: -17s</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div></li><li class="li1"><div class="de1">Nmap done: 1 IP address (1 host up) scanned in 9.71 seconds</div></li></ol></pre>

<p>
Courier no és capaç de llegir els correus de les bústies tradicionals (<em>/var/mail</em>). Hem de fer que els correus es redireccionin i s’emmagatzemin a <em>HOME/MailDir</em> amb procmail. 
</p>

<p>
Instal·lem el programari procmail:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install procmail</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">procmail ja està en la versió més recent (3.22-25+deb9u1).</div></li><li class="li1"><div class="de1">S'ha marcat procmail com instal·lat manualment.</div></li><li class="li1"><div class="de1">El paquets següents s'han instal·lat automàticament i ja no serà necessaris:</div></li><li class="li1"><div class="de1">  apache2-bin apache2-data apache2-utils default-mysql-server galera-3 libaio1 libapache2-mod-php7.0 libapr1 libaprutil1</div></li><li class="li1"><div class="de1">  libaprutil1-dbd-sqlite3 libaprutil1-ldap libconfig-inifiles-perl libdbd-mysql-perl libdbi-perl libhtml-template-perl</div></li><li class="li1"><div class="de1">  libjemalloc1 libreadline5 libterm-readkey-perl mariadb-client-10.1 mariadb-client-core-10.1 mariadb-common</div></li><li class="li1"><div class="de1">  mariadb-server-10.1 mariadb-server-core-10.1 php-common php7.0 php7.0-cli php7.0-common php7.0-json php7.0-mysql</div></li><li class="li1"><div class="de1">  php7.0-opcache php7.0-readline rsync socat</div></li><li class="li1"><div class="de1">Empreu «apt autoremove» per a suprimir-los.</div></li><li class="li1"><div class="de1">0 actualitzats, 0 nous a instal·lar, 0 a suprimir i 311 no actualitzats.</div></li></ol></pre>

<p>
Creem el fitxer /etc/procmailrc on especifiquem que els correus es desin a <em>HOME/MailDir</em>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># file: /etc/procmailrc</div></li><li class="li1"><div class="de1"># system-wide settings for procmail</div></li><li class="li1"><div class="de1">SHELL=&quot;/bin/bash&quot;</div></li><li class="li1"><div class="de1">SENDMAIL=&quot;/usr/sbin/sendmail -oi -t&quot;</div></li><li class="li1"><div class="de1">LOGFILE=&quot;/var/log/procmail.log&quot;</div></li><li class="li1"><div class="de1">DEFAULT=&quot;$HOME/Maildir/&quot;</div></li><li class="li1"><div class="de1">MAILDIR=&quot;$HOME/Maildir/&quot;</div></li><li class="li1"><div class="de1">DROPPRIVS=yes</div></li><li class="li1"><div class="de1">:0</div></li><li class="li1"><div class="de1">* ^X-Spam-Status: Yes</div></li><li class="li1"><div class="de1">.spam/</div></li></ol></pre>

<p>
La directiva DROPPRIVS fa que els correus que es copïin a la carpeta dels usuaris es “processin” com si ho fes l’usuari. Altrament podríem trobar que no podem llegir els correus perquè no tenim permisos. Segons el manual,
“<em>if set to ‘yes’ procmail will drop all privileges it might have had (suid or sgid). This is only useful if you want to guarantee that the bottom half of the /etc/procmailrc file is executed on behalf of the recipient</em>”.
</p>

<p>
Comprovem que funciona des de la línia de comandes, enviant un correu i comprovant que s’ha desat a la carpeta corresponent:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># echo &quot;Correu de prova procmail&quot; | mail -s &quot;PROCMAIL&quot; usuari@server.ioc.cat</div></li><li class="li1"><div class="de1"># ls /home/usuari/Maildir/</div></li><li class="li1"><div class="de1">cur  new  tmp</div></li><li class="li1"><div class="de1"># ls /home/usuari/Maildir/new</div></li><li class="li1"><div class="de1">1569472219.1751_0.server.ioc.cat</div></li><li class="li1"><div class="de1"># cat /home/usuari/Maildir/new/1569472219.1751_0.server.ioc.cat </div></li><li class="li1"><div class="de1">Return-Path: &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Received: from server.ioc.cat (localhost [127.0.0.1])</div></li><li class="li1"><div class="de1">	by server.ioc.cat (8.15.2/8.15.2/Debian-8) with ESMTP id x8Q4UJFm001749</div></li><li class="li1"><div class="de1">	for &lt;usuari@server.ioc.cat&gt;; Thu, 26 Sep 2019 06:30:19 +0200</div></li><li class="li1"><div class="de1">Received: (from root@localhost)</div></li><li class="li1"><div class="de1">	by server.ioc.cat (8.15.2/8.15.2/Submit) id x8Q4UJRK001748;</div></li><li class="li1"><div class="de1">	Thu, 26 Sep 2019 06:30:19 +0200</div></li><li class="li1"><div class="de1">Date: Thu, 26 Sep 2019 06:30:19 +0200</div></li><li class="li1"><div class="de1">From: root &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Message-Id: &lt;201909260430.x8Q4UJRK001748@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Subject: PROCMAIL</div></li><li class="li1"><div class="de1">To: &lt;usuari@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">X-Mailer: mail (GNU Mailutils 3.1.1)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Correu de prova procmail</div></li></ol></pre>

<p>
Comprovem que funciona IMAP amb el client Mutt:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># mutt -f imap://usuari@server.ioc.cat</div></li></ol></pre>

<p>
Els primer cop ens demanarà d’acceptar el certificat:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt-imap1.png" alt="" /></div>

</p>

<p>
Seguidament, com que és una connexió remota, ens demana la contrasenya:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt-imap2.png" alt="" /></div>

</p>

<p>
I finalment, accedim als correus:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt-imap3.png" alt="" /></div>

</p>

<p>
Finalment, instal·lem un client gràfic com KMail:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install kmail</div></li></ol></pre>

<p>
Iniciem i cancel·lem l’assistent. Anem a <em>Settings</em>, <em>Configure Kmail</em>, <em>Comptes</em>, <em>Add</em>, <em>Servidor de correu IMAP</em> i introduim les dades necessàries:
</p>

<p>
<div class="imgelem">
<img src="../media/kmail1.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/kmail2.png" alt="" /></div>

</p>

<p>
Fem Check mail i obtenim el correu:
</p>

<p>
<div class="imgelem">
<img src="../media/kmail3.png" alt="" /></div>

</p>

<p>
<strong>5. Seguretat en el correu</strong>
</p>

<p>
Fins ara tot l’enviament del correu electrònic del servidor instal·lat es realitza en text pla, és a dir, que els paquets no duen cap tipus de xifratge i qualsevol ens podria espiar. Sendmail, com la majoria de servidors de correu, permet fer ús dels mètodes moders d’encriptació per tal de proveir seguretat a les nostres comunicacions.
</p>

<p>
Cal llegir els comentaris del fitxer /etc/mail/tls/starttls.m4 per tal d’afegir a Sendmail el suport TLS.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># cat /etc/mail/tls/starttls.m4</div></li><li class="li1"><div class="de1">divert(-1)dnl</div></li><li class="li1"><div class="de1">####################################################################</div></li><li class="li1"><div class="de1">##### This file is automagically generated -- edit at your own risk</div></li><li class="li1"><div class="de1">#####</div></li><li class="li1"><div class="de1">##### Copyright (c) 2002-2010 Richard Nelson.  All Rights Reserved.</div></li><li class="li1"><div class="de1">#####</div></li><li class="li1"><div class="de1">##### file: /etc/mail/tls/starttls.m4</div></li><li class="li1"><div class="de1">#####		STARTTLS Configuration for Debian Sendmail</div></li><li class="li1"><div class="de1">##### generated via: (/usr/bin/perl v5&gt;24.1)</div></li><li class="li1"><div class="de1">#####		/usr/share/sendmail/update_tlsm4</div></li><li class="li1"><div class="de1">#####		version: 8.15.2 2016-12-08 18:43:49 cowboy</div></li><li class="li1"><div class="de1">##### by: jciberta@debian</div></li><li class="li1"><div class="de1">##### on: Wed Sep 25 18:59:14 2019</div></li><li class="li1"><div class="de1">##### in: /home/jciberta</div></li><li class="li1"><div class="de1">##### input files: /etc/mail/databases</div></li><li class="li1"><div class="de1">#####</div></li><li class="li1"><div class="de1">##### Usage:</div></li><li class="li1"><div class="de1">#####	1) To get *ANY* STARTTLS support for sendmail you</div></li><li class="li1"><div class="de1">#####		A) *MUST* Add this line to /etc/mail/sendmail.mc </div></li><li class="li1"><div class="de1">#####		   `include(`/etc/mail/tls/starttls.m4')dnl'</div></li><li class="li1"><div class="de1">#####		B) *MAY* Add the same line to /etc/mail/submit.mc</div></li><li class="li1"><div class="de1">#####		   to get MSP&lt;-&gt;MTA authentication/encryption </div></li><li class="li1"><div class="de1">#####	2) You may modify the marked portions of this file, those</div></li><li class="li1"><div class="de1">#####	   deal with the cert/key filenames and TLS options.</div></li><li class="li1"><div class="de1">#####	   If you need finer control of TLS options, use the access</div></li><li class="li1"><div class="de1">#####	   database.</div></li><li class="li1"><div class="de1">#####</div></li><li class="li1"><div class="de1">####################################################################</div></li><li class="li1"><div class="de1">divert(0)dnl</div></li><li class="li1"><div class="de1">...</div></li></ol></pre>

<p>
Afegim les línies que es demanen als apartats A i B. Un cop modificats els fitxers cal regenerar la configuració tal com ens indica el fitxer /etc/mail/sendmail.mc:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># cat /etc/mail/sendmail.mc</div></li><li class="li1"><div class="de1">divert(-1)dnl</div></li><li class="li1"><div class="de1">#-----------------------------------------------------------------------------</div></li><li class="li1"><div class="de1"># $Sendmail: debproto.mc,v 8.15.2 2016-12-08 18:43:49 cowboy Exp $</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># Copyright (c) 1998-2010 Richard Nelson.  All Rights Reserved.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># cf/debian/sendmail.mc.  Generated from sendmail.mc.in by configure.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># sendmail.mc prototype config file for building Sendmail 8.15.2</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># Note: the .in file supports 8.7.6 - 9.0.0, but the generated</div></li><li class="li1"><div class="de1">#	file is customized to the version noted above.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># This file is used to configure Sendmail for use with Debian systems.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># If you modify this file, you will have to regenerate /etc/mail/sendmail.cf</div></li><li class="li1"><div class="de1"># by running this file through the m4 preprocessor via one of the following:</div></li><li class="li1"><div class="de1">#	* make   (or make -C /etc/mail)</div></li><li class="li1"><div class="de1">#	* sendmailconfig </div></li><li class="li1"><div class="de1">#	* m4 /etc/mail/sendmail.mc &gt; /etc/mail/sendmail.cf</div></li><li class="li1"><div class="de1"># The first two options are preferred as they will also update other files</div></li><li class="li1"><div class="de1"># that depend upon the contents of this file.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># The best documentation for this .mc file is:</div></li><li class="li1"><div class="de1"># /usr/share/doc/sendmail-doc/cf.README.gz</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1">#-----------------------------------------------------------------------------</div></li><li class="li1"><div class="de1">divert(0)dnl</div></li></ol></pre>

<p>
L’opció més senzilla és amb la utilitat <em>sendmailconfig</em>.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># sendmailconfig</div></li><li class="li1"><div class="de1">...</div></li></ol></pre>

<p>
Per comprovar-ho, tornem a capturar els paquets amb el Wireshark i enviem un altre correu de prova:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># echo &quot;Correu segur de prova&quot; | mail -s &quot;Correu SSL/TLS&quot; usuari@server.ioc.cat</div></li></ol></pre>

<p>
Si anem al Wireshark i seguim l’<em>stream</em> de la conversa, podrem veure que al diàleg ja s’indica que les comunicacions estaran encriptades (a partir de STARTTLS):
</p>

<p>
<div class="imgelem">
<img src="../media/wireshark3.png" alt="" /></div>

</p>

<p>
<strong>Referències</strong>
</p>

<p>
Podeu ampliar la informació consultant les webs del programari utilitzat:
</p>

<p>
<a href="http://www.sendmail.com" class="urlextern" title="http://www.sendmail.com"  rel="nofollow">Sendmail</a>
</p>

<p>
<a href="https://www.courier-mta.org/imap/" class="urlextern" title="https://www.courier-mta.org/imap/"  rel="nofollow">IMAP</a>
</p>

<p>
<a href="http://www.mutt.org/" class="urlextern" title="http://www.mutt.org/"  rel="nofollow">Mutt</a>
</p>

<p>
<a href="https://www.wireshark.org/" class="urlextern" title="https://www.wireshark.org/"  rel="nofollow">Wireshark</a>
</p>

<p>
<a href="https://kde.org/applications/internet/org.kde.kmail2" class="urlextern" title="https://kde.org/applications/internet/org.kde.kmail2"  rel="nofollow">Kmail2</a>
</p>
</div><input class="btn_solution3" type="button" value="Mostra"></input></form>
</p>

</div>

<h2><a id="servidor_de_correu_exim" >Servidor de correu Exim</a></h2>
<div class="level2">

<p>
L’objectiu d’aquesta activitat és aprendre a instal·lar i configurar el servidor SMTP Exim i el servidor IMAP Dovecot.  
</p>

<p>
Exim és un altre agent de tranport de correu (MTA) de programari lliure desenvolupat per la universitat de Cambridge. Dovecot és un servidor de POP3 i IMAP per a sistemes UNIX/Linux amb el focus principalment posat en la seguretat.
</p>

<p>
Realitzeu les següents tasques:
</p>
<ol>
<li class="level1"><div class="li"> Instal·leu Exim en el sistema operatiu Linux.</div>
</li>
<li class="level1"><div class="li"> Configureu el programari Exim. </div>
</li>
<li class="level1"><div class="li"> Realitzeu proves amb el servidor de correu per tal de verificar l’enviament de correus.</div>
</li>
<li class="level1"><div class="li"> Instal·leu i configureu el protocol IMAP (<em>Internet Message Access Protocol</em>) amb el programari Dovecot per tal de permetre l’accés a la bústia de correu de forma remota (MDA, <em>Mail Delivery Agent</em>).</div>
</li>
<li class="level1"><div class="li"> Realitzeu proves amb la comanda Telnet per tal de comprovar el funcionament de protocol IMAP.</div>
</li>
</ol>

<p>
<form action=""><div class="solution ioccontent">
<p>
<strong>1.</strong> Instal·lació del servidor <strong>Exim</strong>.
</p>

<p>
Per tal d’instal·lar el programari, haurem d’accedir al terminal. Comprovem primer com s’anomena el paquet a instal·lar:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-cache search exim | grep exim</div></li><li class="li1"><div class="de1">exim4 - metapackage to ease Exim MTA (v4) installation</div></li><li class="li1"><div class="de1">exim4-base - support files for all Exim MTA (v4) packages</div></li><li class="li1"><div class="de1">exim4-config - configuration for the Exim MTA (v4)</div></li><li class="li1"><div class="de1">exim4-daemon-heavy - Exim MTA (v4) daemon with extended features, including exiscan-acl</div></li><li class="li1"><div class="de1">exim4-daemon-heavy-dbg - debugging symbols for the Exim MTA &quot;heavy&quot; daemon</div></li><li class="li1"><div class="de1">exim4-daemon-light - lightweight Exim MTA (v4) daemon</div></li><li class="li1"><div class="de1">exim4-daemon-light-dbg - debugging symbols for the Exim MTA &quot;light&quot; daemon</div></li><li class="li1"><div class="de1">exim4-dbg - debugging symbols for the Exim MTA (utilities)</div></li><li class="li1"><div class="de1">exim4-dev - header files for the Exim MTA (v4) packages</div></li><li class="li1"><div class="de1">eximon4 - monitor application for the Exim MTA (v4) (X11 interface)</div></li><li class="li1"><div class="de1">exim4-doc-html - documentation for the Exim MTA (v4) in html format</div></li><li class="li1"><div class="de1">exim4-doc-info - documentation for the Exim MTA (v4) in info format</div></li><li class="li1"><div class="de1">geximon - a monitor for the exim MTA</div></li><li class="li1"><div class="de1">rexima - simple ncurses/command-line mixer</div></li><li class="li1"><div class="de1">sa-exim - SpamAssassin filter for Exim</div></li></ol></pre>

<p>
Veiem que hi ha dues versions de MTA del programari Exim, una de lleugera (light) i una altra de pesada (heavy). També existeix un metapaquet que facilita la instal·lació de la lleugera.
</p>

<p>
Si mirem els detalls del paquet <em>exim4-daemon-heavy</em> a l’apartat <em>description-en</em> veurem quines característiques porta de més:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-cache show exim4-daemon-heavy</div></li><li class="li1"><div class="de1">Package: exim4-daemon-heavy</div></li><li class="li1"><div class="de1">Source: exim4</div></li><li class="li1"><div class="de1">Version: 4.92-8+deb10u3~bpo9+1</div></li><li class="li1"><div class="de1">Installed-Size: 1525</div></li><li class="li1"><div class="de1">Maintainer: Exim4 Maintainers &lt;pkg-exim4-maintainers@lists.alioth.debian.org&gt;</div></li><li class="li1"><div class="de1">Architecture: i386</div></li><li class="li1"><div class="de1">Replaces: exim4-base (&lt;= 4.61-1), mail-transport-agent</div></li><li class="li1"><div class="de1">Provides: exim4-localscanapi-2.0, mail-transport-agent</div></li><li class="li1"><div class="de1">Depends: exim4-base (&gt;= 4.92), debconf (&gt;= 0.5) | debconf-2.0, libc6 (&gt;= 2.16), libdb5.3, libgnutls-dane0 (&gt;= 3.5.7), libgnutls30 (&gt;= 3.5.7), libldap-2.4-2 (&gt;= 2.4.7), libmariadbclient18 (&gt;= 10.1.41-0+deb9u1), libpam0g (&gt;= 0.99.7.1), libpcre3, libperl5.24 (&gt;= 5.24.0), libpq5, libsasl2-2, libsqlite3-0 (&gt;= 3.5.9)</div></li><li class="li1"><div class="de1">Conflicts: mail-transport-agent</div></li><li class="li1"><div class="de1">Breaks: clamav-daemon (&lt;&lt; 0.95)</div></li><li class="li1"><div class="de1">Description-en: Exim MTA (v4) daemon with extended features, including exiscan-acl</div></li><li class="li1"><div class="de1"> Exim (v4) is a mail transport agent. This package contains the exim4</div></li><li class="li1"><div class="de1"> daemon with extended features. In addition to the features already</div></li><li class="li1"><div class="de1"> supported by exim4-daemon-light, exim4-daemon-heavy includes LDAP,</div></li><li class="li1"><div class="de1"> sqlite, PostgreSQL and MySQL data lookups, SASL and SPA SMTP authentication,</div></li><li class="li1"><div class="de1"> embedded Perl interpreter, and the content scanning extension</div></li><li class="li1"><div class="de1"> (formerly known as &quot;exiscan-acl&quot;) for integration of virus scanners</div></li><li class="li1"><div class="de1"> and spamassassin.</div></li></ol></pre>

<p>
Instal·lem per al nostres propòsits la versió lleugera:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install exim4</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  exim4-base exim4-config exim4-daemon-light guile-2.0-libs libgc1c2 libgsasl7 libkyotocabinet16v5</div></li><li class="li1"><div class="de1">  libmailutils5 libmariadbclient18 libntlm0 mailutils mailutils-common mysql-common</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  eximon4 exim4-doc-html | exim4-doc-info spf-tools-perl swaks mailutils-mh mailutils-doc</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  exim4 exim4-base exim4-config exim4-daemon-light guile-2.0-libs libgc1c2 libgsasl7 libkyotocabinet16v5</div></li><li class="li1"><div class="de1">  libmailutils5 libmariadbclient18 libntlm0 mailutils mailutils-common mysql-common</div></li><li class="li1"><div class="de1">0 actualitzats, 14 nous a instal·lar, 0 a suprimir i 322 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 7919 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 26,3 MB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
<strong>2.</strong> Configuració del servidor <strong>Exim</strong>.
</p>

<p>
Quan s’instal·la el servidor Exim, aquest ho fa amb una configuració per defecte. Per canviar-la i adequar-la a les nostres necessitats cal executar:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">dpkg-reconfigure exim4-config</div></li></ol></pre>

<p>
<div class="imgelem">
<img src="../media/exim1.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/exim2.png" alt="" /></div>

</p>

<p>
Afegim la nostra IP:
</p>

<p>
<div class="imgelem">
<img src="../media/exim3.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/exim4.png" alt="" /></div>

</p>

<p>
Les següents opcions per defecte, fins que ens demana el format de la bústia. 
</p>

<p>
Els principals formats de bústia que suporta Exim són:
</p>
<ul>
<li class="level1"><div class="li"> <strong>mbox</strong>: tot el correu està centralitzat al directori <em>/var/mail</em>.</div>
</li>
<li class="level1"><div class="li"> <strong>Maildir</strong>: el correu està descentralitzat i cada usuari té la seva bústia en una carpeta del seu directori home.</div>
</li>
</ul>

<p>
Seleccionem el format Maildir:
</p>

<p>
<div class="imgelem">
<img src="../media/exim5.png" alt="" /></div>

</p>

<p>
La configuració un cop realitzada queda desada al fitxer /etc/exim4/update-exim4.conf.conf
</p>

<p>
Si donem un cop d’ull a aquest fitxer veurem la configuració realitzada i a la capçalera ens indica les formes en que es pot configurar Exim, és a dir, editant directament aquest fitxer per posteriorment actualitzar la configuració o simplement executant la comanda <em>dpkg-reconfigure exim4-config</em>.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># /etc/exim4/update-exim4.conf.conf</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># Edit this file and /etc/mailname by hand and execute update-exim4.conf</div></li><li class="li1"><div class="de1"># yourself or use 'dpkg-reconfigure exim4-config'</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># Please note that this is _not_ a dpkg-conffile and that automatic changes</div></li><li class="li1"><div class="de1"># to this file might happen. The code handling this will honor your local</div></li><li class="li1"><div class="de1"># changes, so this is usually fine, but will break local schemes that mess</div></li><li class="li1"><div class="de1"># around with multiple versions of the file.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># update-exim4.conf uses this file to determine variable values to generate</div></li><li class="li1"><div class="de1"># exim configuration macros for the configuration file.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># Most settings found in here do have corresponding questions in the</div></li><li class="li1"><div class="de1"># Debconf configuration, but not all of them.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># This is a Debian specific file</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">dc_eximconfig_configtype='internet'</div></li><li class="li1"><div class="de1">dc_other_hostnames='server.ioc.cat'</div></li><li class="li1"><div class="de1">dc_local_interfaces='127.0.0.1; 10.0.2.15'</div></li><li class="li1"><div class="de1">dc_readhost=''</div></li><li class="li1"><div class="de1">dc_relay_domains=''</div></li><li class="li1"><div class="de1">dc_minimaldns='false'</div></li><li class="li1"><div class="de1">dc_relay_nets=''</div></li><li class="li1"><div class="de1">dc_smarthost=''</div></li><li class="li1"><div class="de1">CFILEMODE='644'</div></li><li class="li1"><div class="de1">dc_use_split_config='false'</div></li><li class="li1"><div class="de1">dc_hide_mailname=''</div></li><li class="li1"><div class="de1">dc_mailname_in_oh='true'</div></li><li class="li1"><div class="de1">dc_localdelivery='maildir_home'</div></li><li class="li1"><div class="de1">root@server:/etc/exim4# </div></li></ol></pre>

<p>
Reiniciem el servei i comprovem que s’està executant correctament.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># service exim4 restart</div></li><li class="li1"><div class="de1"># service exim4 status</div></li><li class="li1"><div class="de1">● exim4.service - LSB: exim Mail Transport Agent</div></li><li class="li1"><div class="de1">   Loaded: loaded (/etc/init.d/exim4; generated; vendor preset: enabled)</div></li><li class="li1"><div class="de1">   Active: active (running) since Sun 2019-09-29 18:47:12 CEST; 4s ago</div></li><li class="li1"><div class="de1">     Docs: man:systemd-sysv-generator(8)</div></li><li class="li1"><div class="de1">  Process: 14719 ExecStop=/etc/init.d/exim4 stop (code=exited, status=0/SUCCESS)</div></li><li class="li1"><div class="de1">  Process: 14730 ExecStart=/etc/init.d/exim4 start (code=exited, status=0/SUCCESS)</div></li><li class="li1"><div class="de1">    Tasks: 1 (limit: 4915)</div></li><li class="li1"><div class="de1">   CGroup: /system.slice/exim4.service</div></li><li class="li1"><div class="de1">           └─14979 /usr/sbin/exim4 -bd -q30m</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">set 29 18:47:12 server.ioc.cat systemd[1]: Stopped LSB: exim Mail Transport Agent.</div></li><li class="li1"><div class="de1">set 29 18:47:12 server.ioc.cat systemd[1]: Starting LSB: exim Mail Transport Agent...</div></li><li class="li1"><div class="de1">set 29 18:47:12 server.ioc.cat exim4[14730]: Starting MTA: exim4.</div></li><li class="li1"><div class="de1">set 29 18:47:12 server.ioc.cat systemd[1]: Started LSB: exim Mail Transport Agent.</div></li></ol></pre>

<p>
La comanda <em>exim</em> permet fer una varietat d’operacions, des de llegir la cua del correu a executar el servei en diverses modalitats. L’opció -bV, apart de donar-nos informació de versions, dates, etc. també realitza una verificació estàtica dels fitxers de configuració, útil per detectar possibles errors.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># man exim</div></li><li class="li1"><div class="de1">...</div></li><li class="li1"><div class="de1">      -bV       This option causes Exim to write the current version number, compilation number, and  com</div></li><li class="li1"><div class="de1">                 pilation  date  of the exim4 binary to the standard output.  It also lists the DBM library</div></li><li class="li1"><div class="de1">                 that is being used, the optional modules (such as specific lookup types), the drivers that</div></li><li class="li1"><div class="de1">                 are  included  in  the  binary, and the name of the run time configuration file that is in</div></li><li class="li1"><div class="de1">                 use.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">                 As part of its operation, -bV causes Exim to read and syntax check its configuration file.</div></li><li class="li1"><div class="de1">                 However,  this is a static check only. It cannot check values that are to be expanded. For</div></li><li class="li1"><div class="de1">                 example, although a misspelt ACL verb is detected, an error in  the  verb's  arguments  is</div></li><li class="li1"><div class="de1">                 not.  You cannot rely on -bV alone to discover (for example) all the typos in the configu</div></li><li class="li1"><div class="de1">                 ration; some realistic testing is needed. The -bh and  -N  options  provide  more  dynamic</div></li><li class="li1"><div class="de1">                 testing facilities.</div></li><li class="li1"><div class="de1">...</div></li></ol></pre>

<p>
No obstant, si el servei s’està executant correctament, és que no hi ha errors en la configuració (almenys estàtica).
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># exim -bV</div></li><li class="li1"><div class="de1">Exim version 4.89 #2 built 03-Sep-2019 18:01:38</div></li><li class="li1"><div class="de1">Copyright (c) University of Cambridge, 1995 - 2017</div></li><li class="li1"><div class="de1">(c) The Exim Maintainers and contributors in ACKNOWLEDGMENTS file, 2007 - 2017</div></li><li class="li1"><div class="de1">Berkeley DB: Berkeley DB 5.3.28: (September  9, 2013)</div></li><li class="li1"><div class="de1">Support for: crypteq iconv() IPv6 GnuTLS move_frozen_messages DKIM DNSSEC Event OCSP PRDR SOCKS TCP_Fast_Open</div></li><li class="li1"><div class="de1">Lookups (built-in): lsearch wildlsearch nwildlsearch iplsearch cdb dbm dbmjz dbmnz dnsdb dsearch nis nis0 passwd</div></li><li class="li1"><div class="de1">Authenticators: cram_md5 plaintext</div></li><li class="li1"><div class="de1">Routers: accept dnslookup ipliteral manualroute queryprogram redirect</div></li><li class="li1"><div class="de1">Transports: appendfile/maildir/mailstore autoreply lmtp pipe smtp</div></li><li class="li1"><div class="de1">Fixed never_users: 0</div></li><li class="li1"><div class="de1">Configure owner: 0:0</div></li><li class="li1"><div class="de1">Size of off_t: 8</div></li><li class="li1"><div class="de1">Configuration file is /var/lib/exim4/config.autogenerated</div></li></ol></pre>

<p>
Podem acabar comprovant que el servei s’està executant i que té el port SMTP obert amb <strong>nmap</strong>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># nmap -T4 -A localhost</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Starting Nmap 7.40 ( https://nmap.org ) at 2019-09-29 19:16 CEST</div></li><li class="li1"><div class="de1">Nmap scan report for localhost (127.0.0.1)</div></li><li class="li1"><div class="de1">Host is up (0.000017s latency).</div></li><li class="li1"><div class="de1">Not shown: 997 closed ports</div></li><li class="li1"><div class="de1">PORT     STATE SERVICE VERSION</div></li><li class="li1"><div class="de1">25/tcp   open  smtp    Exim smtpd 4.89</div></li><li class="li1"><div class="de1">| smtp-commands: server.ioc.cat Hello localhost [127.0.0.1], SIZE 52428800, 8BITMIME, PIPELINING, PRDR, HELP, </div></li><li class="li1"><div class="de1">|_ Commands supported: AUTH HELO EHLO MAIL RCPT DATA BDAT NOOP QUIT RSET HELP </div></li><li class="li1"><div class="de1">Device type: general purpose</div></li><li class="li1"><div class="de1">Running: Linux 3.X|4.X</div></li><li class="li1"><div class="de1">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</div></li><li class="li1"><div class="de1">OS details: Linux 3.8 - 4.6</div></li><li class="li1"><div class="de1">Network Distance: 0 hops</div></li><li class="li1"><div class="de1">Service Info: Host: server.ioc.cat</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div></li><li class="li1"><div class="de1">Nmap done: 1 IP address (1 host up) scanned in 146.90 seconds</div></li></ol></pre>

<p>
<strong>3. Proves amb el servidor de correu</strong>
</p>

<p>
Crearem un usuari anomenat alumne per fer les proves. Si el volem crear de forma no interactiva i directament des de comanda farem servir useradd:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># useradd -m alumne -s /bin/bash</div></li><li class="li1"><div class="de1"># passwd alumne</div></li><li class="li1"><div class="de1">Introduïu la nova contrasenya d'UNIX: </div></li><li class="li1"><div class="de1">Torneu a escriure la nova contrasenya d'UNIX: </div></li><li class="li1"><div class="de1">passwd: s'ha actualitzat la contrasenya satisfactòriament</div></li></ol></pre>

<p>
Enviem un correu des del nostre usuari a l’usuari alumne@server.ioc.cat amb la comanda <em>mail</em> (del paquet <em>mailutils</em>). Per acabar el correu es fa amb CTRL+D:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># mail alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Cc: </div></li><li class="li1"><div class="de1">Subject: 1a prova de correu amb Exim</div></li><li class="li1"><div class="de1">Aquesta és la 1a prova de correu</div></li></ol></pre>

<p>
Sense llegir el correu encara, podem observar com s’emmagatzema a la bústia corresponent i veiem que el correu és un simple fitxer. 
</p>

<p>
L’estructura del Maildir està composta per tres carpetes: la actual (cur), la nova (new) i la temporal (tmp).
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># ls /home/alumne/Maildir/</div></li><li class="li1"><div class="de1">cur  new  tmp</div></li><li class="li1"><div class="de1"># ls /home/alumne/Maildir/new</div></li><li class="li1"><div class="de1">1569776612.H693982P15236.server.ioc.cat</div></li><li class="li1"><div class="de1"># cat /home/alumne/Maildir/new/1569776612.H693982P15236.server.ioc.cat </div></li><li class="li1"><div class="de1">Return-path: &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Envelope-to: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Delivery-date: Sun, 29 Sep 2019 19:03:32 +0200</div></li><li class="li1"><div class="de1">Received: from root by server.ioc.cat with local (Exim 4.89)</div></li><li class="li1"><div class="de1">	(envelope-from &lt;root@server.ioc.cat&gt;)</div></li><li class="li1"><div class="de1">	id 1iEcbc-0003xi-K1</div></li><li class="li1"><div class="de1">	for alumne@server.ioc.cat; Sun, 29 Sep 2019 19:03:32 +0200</div></li><li class="li1"><div class="de1">To: &lt;alumne@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Subject: 1a prova de correu amb Exim</div></li><li class="li1"><div class="de1">X-Mailer: mail (GNU Mailutils 3.1.1)</div></li><li class="li1"><div class="de1">Message-Id: &lt;E1iEcbc-0003xi-K1@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">From: root@server.ioc.cat</div></li><li class="li1"><div class="de1">Date: Sun, 29 Sep 2019 19:03:32 +0200</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Aquesta és la 1a prova de correu</div></li><li class="li1"><div class="de1">root@server:~# </div></li></ol></pre>

<p>
Instal·lem un client de correu en mode text, per exemple <strong>Mutt</strong>.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install mutt</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">El paquets següents s'han instal·lat automàticament i ja no serà necessaris:</div></li><li class="li1"><div class="de1">  alpine-doc mlock</div></li><li class="li1"><div class="de1">Empreu «apt autoremove» per a suprimir-los.</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  libgmime-2.6-0 libgpgme11 libnotmuch4 libtokyocabinet9</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  gpgsm urlview mixmaster</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  libgmime-2.6-0 libgpgme11 libnotmuch4 libtokyocabinet9 mutt</div></li><li class="li1"><div class="de1">0 actualitzats, 5 nous a instal·lar, 0 a suprimir i 322 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 2497 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 8927 kB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
Mutt per defecte llegeix el correu en format <em>mbox</em>. Li haurem d’indicar que ha de llegir la bústia amb el format Maildir, però primer passarem a ser l’usuari alumne:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># su alumne</div></li><li class="li1"><div class="de1">$ cd /home/alumne</div></li><li class="li1"><div class="de1">$ mutt -f ./Maildir</div></li></ol></pre>

<p>
<div class="imgelem">
<img src="../media/mutt-exim1.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-exim2.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-exim3.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-exim4.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-exim5.png" alt="" /></div>

</p>

<p>
<strong>4. Accés remot al correu amb IMAP mitjançant el programari Dovecot</strong>
</p>

<p>
Dovecot és un programari servidor POP3 i IMAP de correu de codi obert, principalment per a sistemes UNIX/Linux.
</p>

<p>
Cerquem el nom del paquet a instal·lar amb <em>apt-cache</em>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-cache search dovecot | grep imap</div></li><li class="li1"><div class="de1">dovecot-imapd - secure POP3/IMAP server - IMAP daemon</div></li></ol></pre>

<p>
Instal·lem el programari per a IMAP.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install dovecot-imapd</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">El paquets següents s'han instal·lat automàticament i ja no serà necessaris:</div></li><li class="li1"><div class="de1">  alpine-doc mlock</div></li><li class="li1"><div class="de1">Empreu «apt autoremove» per a suprimir-los.</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  dovecot-core libstemmer0d</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  ntp dovecot-gssapi dovecot-sieve dovecot-pgsql dovecot-mysql dovecot-sqlite dovecot-ldap dovecot-pop3d</div></li><li class="li1"><div class="de1">  dovecot-lmtpd dovecot-managesieved dovecot-solr dovecot-lucene ufw</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  dovecot-core dovecot-imapd libstemmer0d</div></li><li class="li1"><div class="de1">0 actualitzats, 3 nous a instal·lar, 0 a suprimir i 322 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 4439 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 11,2 MB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
Els arxius de configuració estan a /etc/dovecot i el principal és /etc/dovecot/dovecot.conf. En aquest descomentem la directiva listen fent que escolti només per a IPv4:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">listen = *</div></li></ol></pre>

<p>
En aquest mateix fitxer queda especificat a través d’un <em>include</em> els protocols a escoltar:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># ls /usr/share/dovecot/protocols.d</div></li><li class="li1"><div class="de1">imapd.protocol</div></li><li class="li1"><div class="de1"># cat /usr/share/dovecot/protocols.d/imapd.protocol </div></li><li class="li1"><div class="de1">protocols = $protocols imap</div></li></ol></pre>

<p>
S’ha d’indicat també el mecanisme d’autenticació a través del fitxer /etc/dovecot/conf.d/10-auth.conf:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">##</div></li><li class="li1"><div class="de1">## Authentication processes</div></li><li class="li1"><div class="de1">##</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"># Disable LOGIN command and all other plaintext authentications unless</div></li><li class="li1"><div class="de1"># SSL/TLS is used (LOGINDISABLED capability). Note that if the remote IP</div></li><li class="li1"><div class="de1"># matches the local IP (ie. you're connecting from the same computer), the</div></li><li class="li1"><div class="de1"># connection is considered secure and plaintext authentication is allowed.</div></li><li class="li1"><div class="de1"># See also ssl=required setting.</div></li><li class="li1"><div class="de1">disable_plaintext_auth = no </div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">...</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"># Space separated list of wanted authentication mechanisms:</div></li><li class="li1"><div class="de1">#   plain login digest-md5 cram-md5 ntlm rpa apop anonymous gssapi otp skey</div></li><li class="li1"><div class="de1">#   gss-spnego</div></li><li class="li1"><div class="de1"># NOTE: See also disable_plaintext_auth setting.</div></li><li class="li1"><div class="de1">auth_mechanisms = plain login</div></li></ol></pre>

<p>
Configurem el format de la bústia al fitxer /etc/dovecot/conf.d/10-mail.conf, que està plenament autodocumentat i amb exemples per als principals formats:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">##</div></li><li class="li1"><div class="de1">## Mailbox locations and namespaces</div></li><li class="li1"><div class="de1">##</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"># Location for users' mailboxes. The default is empty, which means that Dovecot</div></li><li class="li1"><div class="de1"># tries to find the mailboxes automatically. This won't work if the user</div></li><li class="li1"><div class="de1"># doesn't yet have any mail, so you should explicitly tell Dovecot the full</div></li><li class="li1"><div class="de1"># location.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># If you're using mbox, giving a path to the INBOX file (eg. /var/mail/%u)</div></li><li class="li1"><div class="de1"># isn't enough. You'll also need to tell Dovecot where the other mailboxes are</div></li><li class="li1"><div class="de1"># kept. This is called the &quot;root mail directory&quot;, and it must be the first</div></li><li class="li1"><div class="de1"># path given in the mail_location setting.</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># There are a few special variables you can use, eg.:</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1">#   %u - username</div></li><li class="li1"><div class="de1">#   %n - user part in user@domain, same as %u if there's no domain</div></li><li class="li1"><div class="de1">#   %d - domain part in user@domain, empty if there's no domain</div></li><li class="li1"><div class="de1">#   %h - home directory</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># See doc/wiki/Variables.txt for full list. Some examples:</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1">#   mail_location = maildir:~/Maildir</div></li><li class="li1"><div class="de1">#   mail_location = mbox:~/mail:INBOX=/var/mail/%u</div></li><li class="li1"><div class="de1">#   mail_location = mbox:/var/mail/%d/%1n/%n:INDEX=/var/indexes/%d/%1n/%n</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1"># &lt;doc/wiki/MailLocation.txt&gt;</div></li><li class="li1"><div class="de1">#</div></li><li class="li1"><div class="de1">mail_location = maildir:~/Maildir</div></li></ol></pre>

<p>
Reiniciem el servei:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># service dovecot restart</div></li><li class="li1"><div class="de1"># service dovecot status</div></li><li class="li1"><div class="de1">● dovecot.service - Dovecot IMAP/POP3 email server</div></li><li class="li1"><div class="de1">   Loaded: loaded (/lib/systemd/system/dovecot.service; enabled; vendor preset: enabled)</div></li><li class="li1"><div class="de1">   Active: active (running) since Sun 2019-09-29 19:46:57 CEST; 3s ago</div></li><li class="li1"><div class="de1">     Docs: man:dovecot(1)</div></li><li class="li1"><div class="de1">           http://wiki2.dovecot.org/</div></li><li class="li1"><div class="de1">  Process: 19961 ExecStop=/usr/bin/doveadm stop (code=exited, status=0/SUCCESS)</div></li><li class="li1"><div class="de1">  Process: 19966 ExecStart=/usr/sbin/dovecot (code=exited, status=0/SUCCESS)</div></li><li class="li1"><div class="de1"> Main PID: 19968 (dovecot)</div></li><li class="li1"><div class="de1">    Tasks: 4 (limit: 4915)</div></li><li class="li1"><div class="de1">   CGroup: /system.slice/dovecot.service</div></li><li class="li1"><div class="de1">           ├─19968 /usr/sbin/dovecot</div></li><li class="li1"><div class="de1">           ├─19969 dovecot/anvil</div></li><li class="li1"><div class="de1">           ├─19970 dovecot/log</div></li><li class="li1"><div class="de1">           └─19972 dovecot/config</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">set 29 19:46:57 server.ioc.cat systemd[1]: Starting Dovecot IMAP/POP3 email server...</div></li><li class="li1"><div class="de1">set 29 19:46:57 server.ioc.cat systemd[1]: dovecot.service: PID file /var/run/dovecot/master.pid not readable </div></li><li class="li1"><div class="de1">set 29 19:46:57 server.ioc.cat dovecot[19968]: master: Dovecot v2.2.27 (c0f36b0) starting up for imap (core du</div></li><li class="li1"><div class="de1">set 29 19:46:57 server.ioc.cat systemd[1]: Started Dovecot IMAP/POP3 email server.</div></li><li class="li1"><div class="de1">lines 1-19/19 (END)</div></li></ol></pre>

<p>
Tornem a executar <em>nmap</em> per veure quins ports hi ha oberts:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># nmap -A -T4 localhost</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Starting Nmap 7.40 ( https://nmap.org ) at 2019-09-29 19:52 CEST</div></li><li class="li1"><div class="de1">Nmap scan report for localhost (127.0.0.1)</div></li><li class="li1"><div class="de1">Host is up (0.000019s latency).</div></li><li class="li1"><div class="de1">Not shown: 996 closed ports</div></li><li class="li1"><div class="de1">PORT     STATE SERVICE VERSION</div></li><li class="li1"><div class="de1">25/tcp   open  smtp    Exim smtpd 4.89</div></li><li class="li1"><div class="de1">| smtp-commands: server.ioc.cat Hello localhost [127.0.0.1], SIZE 52428800, 8BITMIME, PIPELINING, PRDR, HELP, </div></li><li class="li1"><div class="de1">|_ Commands supported: AUTH HELO EHLO MAIL RCPT DATA BDAT NOOP QUIT RSET HELP </div></li><li class="li1"><div class="de1">|_smtp-ntlm-info: ERROR: Script execution failed (use -d to debug)</div></li><li class="li1"><div class="de1">143/tcp  open  imap    Dovecot imapd</div></li><li class="li1"><div class="de1">|_imap-capabilities: AUTH=LOGINA0001 more ID LITERAL+ AUTH=PLAIN have IDLE IMAP4rev1 listed LOGIN-REFERRALS ENABLE capabilities Pre-login SASL-IR OK post-login</div></li><li class="li1"><div class="de1">Device type: general purpose</div></li><li class="li1"><div class="de1">Running: Linux 3.X|4.X</div></li><li class="li1"><div class="de1">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</div></li><li class="li1"><div class="de1">OS details: Linux 3.8 - 4.6</div></li><li class="li1"><div class="de1">Network Distance: 0 hops</div></li><li class="li1"><div class="de1">Service Info: Host: server.ioc.cat</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div></li><li class="li1"><div class="de1">Nmap done: 1 IP address (1 host up) scanned in 155.06 seconds</div></li></ol></pre>

<p>
I comprovem que funciona IMAP amb mutt:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># mutt -f imap://alumne@server.ioc.cat</div></li></ol></pre>

<p>
Ens demanarà la contrasenya i se’ns mostrarà seguidament el correu entrant:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt-exim-imap.png" alt="" /></div>

</p>

<p>
Per acabar, instal·lem i configurem un client de correu gràfic. Aquest cop Mozilla Thunderbird:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install thunderbird</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">El paquets següents s'han instal·lat automàticament i ja no serà necessaris:</div></li><li class="li1"><div class="de1">  alpine-doc mlock</div></li><li class="li1"><div class="de1">Empreu «apt autoremove» per a suprimir-los.</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  lightning</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  calendar-google-provider fonts-lyx apparmor</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  lightning thunderbird</div></li><li class="li1"><div class="de1">0 actualitzats, 2 nous a instal·lar, 0 a suprimir i 322 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 41,0 MB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 167 MB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
En iniciar ens demanarà si volem configurar un compte existent:
</p>

<p>
<div class="imgelem">
<img src="../media/thunderbird1.png" alt="" /></div>

</p>

<p>
Seguidament configurem els paràmetres per al correu SMTP i IMAP:
</p>

<p>
<div class="imgelem">
<img src="../media/thunderbird2.png" alt="" /></div>

</p>

<p>
Ens avisa que no estem utilitzant cap tipus d’encriptació i que les dades viatjaran visibles per Internet:
</p>

<p>
<div class="imgelem">
<img src="../media/thunderbird3.png" alt="" /></div>

</p>

<p>
Finalment, obrim la carpeta <em>Inbox</em> del nostre correu i observem el correu rebut anteriorment:
</p>

<p>
<div class="imgelem">
<img src="../media/thunderbird4.png" alt="" /></div>

</p>

<p>
<strong>5. Proves avançades amb Telnet</strong>
</p>

<p>
L’aplicació telnet, a part de donar servei al protocol telnet per a la connexió (insegura) remota d’equips, és una navalla suïssa que permet obrir d’altres port i treballar directament a nivell del protocol obert. És el cas dels protocols SMTP i IMAP on podrem executar les comandes pròpies d’aquests protocols i que estan especificades en els seus respectius <acronym title="Request for Comments">RFC</acronym>.
</p>

<p>
Enviem un correu amb Telnet. El protocol SMTP està especificat al <acronym title="Request for Comments">RFC</acronym> 5321. En el següent exemple s’ha fet servidr les comandes: ehlo, mail, rcpt, data i quit.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># telnet server.ioc.cat smtp</div></li><li class="li1"><div class="de1">Trying 10.0.2.15...</div></li><li class="li1"><div class="de1">Connected to server.ioc.cat.</div></li><li class="li1"><div class="de1">Escape character is '^]'.</div></li><li class="li1"><div class="de1">220 server.ioc.cat ESMTP Exim 4.89 Sun, 29 Sep 2019 20:10:22 +0200</div></li><li class="li1"><div class="de1">ehlo hi</div></li><li class="li1"><div class="de1">250-server.ioc.cat Hello hi [10.0.2.15]</div></li><li class="li1"><div class="de1">250-SIZE 52428800</div></li><li class="li1"><div class="de1">250-8BITMIME</div></li><li class="li1"><div class="de1">250-PIPELINING</div></li><li class="li1"><div class="de1">250-PRDR</div></li><li class="li1"><div class="de1">250 HELP</div></li><li class="li1"><div class="de1">mail from:root@server.ioc.cat</div></li><li class="li1"><div class="de1">250 OK</div></li><li class="li1"><div class="de1">rcpt to:alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">250 Accepted</div></li><li class="li1"><div class="de1">data</div></li><li class="li1"><div class="de1">354 Enter message, ending with &quot;.&quot; on a line by itself</div></li><li class="li1"><div class="de1">Subject: Prova telnet</div></li><li class="li1"><div class="de1">Prova de telnet</div></li><li class="li1"><div class="de1">.</div></li><li class="li1"><div class="de1">250 OK id=1iEdeu-0005O9-BG</div></li><li class="li1"><div class="de1">quit</div></li><li class="li1"><div class="de1">221 server.ioc.cat closing connection</div></li><li class="li1"><div class="de1">Connection closed by foreign host.</div></li></ol></pre>

<p>
Mostrem el correu enviat amb telnet obrint el port IMAP. El protocol IMAP està especificat al <acronym title="Request for Comments">RFC</acronym> 5301. A l’apartat 6 hi ha la part relativa a les comandes IMAP
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># telnet server.ioc.cat imap</div></li><li class="li1"><div class="de1">Trying 10.0.2.15...</div></li><li class="li1"><div class="de1">Connected to server.ioc.cat.</div></li><li class="li1"><div class="de1">Escape character is '^]'.</div></li><li class="li1"><div class="de1">* OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE AUTH=PLAIN AUTH=LOGIN] Dovecot ready.</div></li><li class="li1"><div class="de1">1 login alumne alumne</div></li><li class="li1"><div class="de1">1 OK [CAPABILITY IMAP4rev1 LITERAL+ SASL-IR LOGIN-REFERRALS ID ENABLE IDLE SORT SORT=DISPLAY THREAD=REFERENCES THREAD=REFS THREAD=ORDEREDSUBJECT MULTIAPPEND URL-PARTIAL CATENATE UNSELECT CHILDREN NAMESPACE UIDPLUS LIST-EXTENDED I18NLEVEL=1 CONDSTORE QRESYNC ESEARCH ESORT SEARCHRES WITHIN CONTEXT=SEARCH LIST-STATUS BINARY MOVE SPECIAL-USE] Logged in</div></li><li class="li1"><div class="de1">2 list &quot;&quot; &quot;*&quot;</div></li><li class="li1"><div class="de1">* LIST (\HasNoChildren \Trash) &quot;.&quot; Trash</div></li><li class="li1"><div class="de1">* LIST (\HasNoChildren) &quot;.&quot; INBOX</div></li><li class="li1"><div class="de1">2 OK List completed (0.000 + 0.000 secs).</div></li><li class="li1"><div class="de1">3 select inbox</div></li><li class="li1"><div class="de1">* FLAGS (\Answered \Flagged \Deleted \Seen \Draft)</div></li><li class="li1"><div class="de1">* OK [PERMANENTFLAGS (\Answered \Flagged \Deleted \Seen \Draft \*)] Flags permitted.</div></li><li class="li1"><div class="de1">* 2 EXISTS</div></li><li class="li1"><div class="de1">* 1 RECENT</div></li><li class="li1"><div class="de1">* OK [UNSEEN 2] First unseen.</div></li><li class="li1"><div class="de1">* OK [UIDVALIDITY 1569779845] UIDs valid</div></li><li class="li1"><div class="de1">* OK [UIDNEXT 3] Predicted next UID</div></li><li class="li1"><div class="de1">3 OK [READ-WRITE] Select completed (0.000 + 0.000 secs).</div></li><li class="li1"><div class="de1">4 fetch 2 all</div></li><li class="li1"><div class="de1">* 2 FETCH (FLAGS (\Recent) INTERNALDATE &quot;29-Sep-2019 20:11:21 +0200&quot; RFC822.SIZE 366 ENVELOPE (NIL &quot;Prova telnet&quot; NIL NIL NIL NIL NIL NIL NIL NIL))</div></li><li class="li1"><div class="de1">4 OK Fetch completed (0.001 + 0.000 secs).</div></li><li class="li1"><div class="de1">5 fetch 2 body[]</div></li><li class="li1"><div class="de1">* 2 FETCH (BODY[] {366}</div></li><li class="li1"><div class="de1">Return-path: &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Envelope-to: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Delivery-date: Sun, 29 Sep 2019 20:11:21 +0200</div></li><li class="li1"><div class="de1">Received: from [10.0.2.15] (helo=hi)</div></li><li class="li1"><div class="de1">	by server.ioc.cat with esmtp (Exim 4.89)</div></li><li class="li1"><div class="de1">	(envelope-from &lt;root@server.ioc.cat&gt;)</div></li><li class="li1"><div class="de1">	id 1iEdeu-0005O9-BG</div></li><li class="li1"><div class="de1">	for alumne@server.ioc.cat; Sun, 29 Sep 2019 20:11:21 +0200</div></li><li class="li1"><div class="de1">Subject: Prova telnet</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Prova de Telnet</div></li><li class="li1"><div class="de1">)</div></li><li class="li1"><div class="de1">5 OK Fetch completed (0.001 + 0.000 secs).</div></li><li class="li1"><div class="de1">6 logout</div></li><li class="li1"><div class="de1">* BYE Logging out</div></li><li class="li1"><div class="de1">6 OK Logout completed (0.000 + 0.000 secs).</div></li><li class="li1"><div class="de1">Connection closed by foreign host.</div></li></ol></pre>

<p>
<strong>Referències</strong>
</p>

<p>
<a href="https://www.exim.org/" class="urlextern" title="https://www.exim.org/"  rel="nofollow">Exim</a>
</p>

<p>
<a href="https://www.dovecot.org/" class="urlextern" title="https://www.dovecot.org/"  rel="nofollow">Dovecot</a>
</p>

<p>
<a href="https://www.thunderbird.net/ca/" class="urlextern" title="https://www.thunderbird.net/ca/"  rel="nofollow">Thunderbird</a>
</p>
</div><input class="btn_solution3" type="button" value="Mostra"></input></form>
</p>

</div>

<h2><a id="servidor_de_correu_postfix" >Servidor de correu Postfix</a></h2>
<div class="level2">

<p>
L’objectiu d’aquesta activitat és aprendre a instal·lar i configurar el servidor de correu Postfix i el servidor POP3 Courier.  
</p>

<p>
Postfix és un altre agent de tranport de correu (MTA) de programari lliure desenvolupat inicialment en un centre d’IBM. Com a servidor POP s’usarà el servidor Courier, programari que ja s’ha utilitzat anteriorment per al protocol IMAP.
</p>

<p>
Realitzeu les següents tasques:
</p>
<ol>
<li class="level1"><div class="li"> Instal·leu Postfix en el sistema operatiu Linux.</div>
</li>
<li class="level1"><div class="li"> Configureu el programari Postfix. </div>
</li>
<li class="level1"><div class="li"> Realitzeu proves amb el servidor de correu per tal de verificar l’enviament de correus.</div>
</li>
<li class="level1"><div class="li"> Instal·leu i configureu el protocol POP amb el programari Courier per tal de permetre l’accés a la bústia de correu de forma remota.</div>
</li>
<li class="level1"><div class="li"> Realitzeu proves amb la comanda telnet per tal de comprovar el funcionament de protocol POP.</div>
</li>
</ol>

<p>
<form action=""><div class="solution ioccontent">
<p>
<strong>1. Instal·lació del servidor Postfix</strong>
</p>

<p>
Per tal d’instal·lar el programari Postfix, accedim al terminal i executem:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install postfix</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  postfix-sqlite ssl-cert</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  procmail postfix-mysql postfix-pgsql postfix-ldap postfix-pcre postfix-lmdb sasl2-bin dovecot-common resolvconf postfix-cdb mail-reader</div></li><li class="li1"><div class="de1">  ufw postfix-doc openssl-blacklist</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  postfix postfix-sqlite ssl-cert</div></li><li class="li1"><div class="de1">0 actualitzats, 3 nous a instal·lar, 0 a suprimir i 322 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 1820 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 4319 kB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
Com a tipus de configuració, seleccionem <em>Lloc d’Internet</em>:
</p>

<p>
<div class="imgelem">
<img src="../media/postfix1.png" alt="" /></div>

</p>

<p>
I indiquem el nom del correu del sistema:
</p>

<p>
<div class="imgelem">
<img src="../media/postfix2.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/postfix3.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/postfix4.png" alt="" /></div>

</p>

<p>
<strong>2. Configuració del servidor Postfix</strong>
</p>

<p>
Acabem de configurar el servidor amb la comanda <em>dpkg-reconfigure postfix</em>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">dpkg-reconfigure postfix</div></li></ol></pre>

<p>
<div class="imgelem">
<img src="../media/postfix5.png" alt="" /></div>

</p>

<p>
I indiquem la nostra IP:
</p>

<p>
<div class="imgelem">
<img src="../media/postfix6.png" alt="" /></div>

</p>

<p>
Aquesta configuració fa que es modifiqui el fitxer de configuració principal de Postfix, que és /etc/postfix/main.cf. Si hi donem un cop d’ull, veurem les modificacions realitzades. Òbviament, també es podria haver editat directament sobre el fitxer.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># cat /etc/postfix/main.cf</div></li><li class="li1"><div class="de1">...</div></li><li class="li1"><div class="de1">myhostname = server.ioc.cat</div></li><li class="li1"><div class="de1">alias_maps = hash:/etc/aliases</div></li><li class="li1"><div class="de1">alias_database = hash:/etc/aliases</div></li><li class="li1"><div class="de1">myorigin = /etc/mailname</div></li><li class="li1"><div class="de1">mydestination = server.ioc.cat, localhost</div></li><li class="li1"><div class="de1">relayhost = </div></li><li class="li1"><div class="de1">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128, 10.0.2.15</div></li><li class="li1"><div class="de1">mailbox_size_limit = 0</div></li><li class="li1"><div class="de1">recipient_delimiter = +</div></li><li class="li1"><div class="de1">inet_interfaces = all</div></li><li class="li1"><div class="de1">inet_protocols = all</div></li></ol></pre>

<p>
Configurem Postfix per que usi el format de bústia Maildir:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">postconf -e 'home_mailbox = Maildir/'</div></li><li class="li1"><div class="de1">postconf -e 'mailbox_command ='</div></li></ol></pre>

<p>
I tornem a comprovar com s’ha modificat el fitxer de configuració:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># cat /etc/postfix/main.cf</div></li><li class="li1"><div class="de1">...</div></li><li class="li1"><div class="de1">myhostname = server.ioc.cat</div></li><li class="li1"><div class="de1">alias_maps = hash:/etc/aliases</div></li><li class="li1"><div class="de1">alias_database = hash:/etc/aliases</div></li><li class="li1"><div class="de1">myorigin = /etc/mailname</div></li><li class="li1"><div class="de1">mydestination = server.ioc.cat, localhost</div></li><li class="li1"><div class="de1">relayhost = </div></li><li class="li1"><div class="de1">mynetworks = 127.0.0.0/8 [::ffff:127.0.0.0]/104 [::1]/128, 10.0.2.15</div></li><li class="li1"><div class="de1">mailbox_size_limit = 0</div></li><li class="li1"><div class="de1">recipient_delimiter = +</div></li><li class="li1"><div class="de1">inet_interfaces = all</div></li><li class="li1"><div class="de1">inet_protocols = all</div></li><li class="li1"><div class="de1">home_mailbox = Maildir/</div></li><li class="li1"><div class="de1">mailbox_command = </div></li></ol></pre>

<p>
Per tant, Postfix es pot configurar de tres maneres diferents: gràficament, des de comandes o directament sobre els fitxers. No obstant, al final cal reiniciar el servei per tal que les modificacions tinguin efecte:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># service postfix restart</div></li></ol></pre>

<p>
Observem amb <em>nmap</em> que obre el port 25 (SMTP):
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># nmap -T4 -A localhost</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Starting Nmap 7.40 ( https://nmap.org ) at 2019-10-01 15:05 CEST</div></li><li class="li1"><div class="de1">Nmap scan report for localhost (127.0.0.1)</div></li><li class="li1"><div class="de1">Host is up (0.000016s latency).</div></li><li class="li1"><div class="de1">Not shown: 997 closed ports</div></li><li class="li1"><div class="de1">PORT     STATE SERVICE VERSION</div></li><li class="li1"><div class="de1">25/tcp   open  smtp    Postfix smtpd</div></li><li class="li1"><div class="de1">|_smtp-commands: server.ioc.cat, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, </div></li><li class="li1"><div class="de1">| ssl-cert: Subject: commonName=server.ioc.cat</div></li><li class="li1"><div class="de1">| Subject Alternative Name: DNS:server.ioc.cat</div></li><li class="li1"><div class="de1">| Not valid before: 2019-09-29T09:30:48</div></li><li class="li1"><div class="de1">|_Not valid after:  2029-09-26T09:30:48</div></li><li class="li1"><div class="de1">|_ssl-date: ERROR: Script execution failed (use -d to debug)</div></li><li class="li1"><div class="de1">Device type: general purpose</div></li><li class="li1"><div class="de1">Running: Linux 3.X|4.X</div></li><li class="li1"><div class="de1">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</div></li><li class="li1"><div class="de1">OS details: Linux 3.8 - 4.6</div></li><li class="li1"><div class="de1">Network Distance: 0 hops</div></li><li class="li1"><div class="de1">Service Info: Host:  server.ioc.cat</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div></li><li class="li1"><div class="de1">Nmap done: 1 IP address (1 host up) scanned in 147.36 seconds</div></li></ol></pre>

<p>
<strong>3. Proves amb el servidor de correu</strong>
</p>

<p>
Relitzem una primera prova amb el servidor amb la comanda <em>mail</em> des de la línia de comandes i comprovem que s’ha creat a la bústia corresponent:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># echo &quot;Correu de prova amb Postfix&quot; | mail -s &quot;Prova Postfix&quot; alumne@server.ioc.cat</div></li><li class="li1"><div class="de1"># ls /home/alumne</div></li><li class="li1"><div class="de1">mail  Maildir</div></li><li class="li1"><div class="de1"># ls /home/alumne/Maildir</div></li><li class="li1"><div class="de1">cur  new  tmp</div></li><li class="li1"><div class="de1"># ls /home/alumne/Maildir/new</div></li><li class="li1"><div class="de1">1569936540.V801I4a166M737765.server.ioc.cat</div></li><li class="li1"><div class="de1"># cat /home/alumne/Maildir/new/1569936540.V801I4a166M737765.server.ioc.cat </div></li><li class="li1"><div class="de1">Return-Path: &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">X-Original-To: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Delivered-To: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Received: by server.ioc.cat (Postfix, from userid 0)</div></li><li class="li1"><div class="de1">	id AFDA27942; Tue,  1 Oct 2019 15:29:00 +0200 (CEST)</div></li><li class="li1"><div class="de1">Subject: Prova Postfix</div></li><li class="li1"><div class="de1">To: &lt;alumne@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">X-Mailer: mail (GNU Mailutils 3.1.1)</div></li><li class="li1"><div class="de1">Message-Id: &lt;20191001132900.AFDA27942@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Date: Tue,  1 Oct 2019 15:29:00 +0200 (CEST)</div></li><li class="li1"><div class="de1">From: root@server.ioc.cat (root)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Correu de prova amb Postfix</div></li></ol></pre>

<p>
<strong>NotMuch</strong> és una eina que s’utilitza des de la línia de comandes per a la recerca ràpida de correu en bústies. No està pensada per enviar correus ni per rebre’n. Però per a comprovar el correu, ja ens va bé.
</p>

<p>
Comprovem-lo amb NotMuch. Primer cal instal·lar-lo i configurar-lo:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install notmuch</div></li><li class="li1"><div class="de1"># su alumne</div></li><li class="li1"><div class="de1">$ notmuch</div></li><li class="li1"><div class="de1">Welcome to notmuch!</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">The goal of notmuch is to help you manage and search your collection of</div></li><li class="li1"><div class="de1">email, and to efficiently keep up with the flow of email as it comes in.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Notmuch needs to know a few things about you such as your name and email</div></li><li class="li1"><div class="de1">address, as well as the directory that contains your email. This is where</div></li><li class="li1"><div class="de1">you already have mail stored and where messages will be delivered in the</div></li><li class="li1"><div class="de1">future. This directory can contain any number of sub-directories. Regular</div></li><li class="li1"><div class="de1">files in these directories should be individual email messages. If there</div></li><li class="li1"><div class="de1">are other, non-email files (such as indexes maintained by other email</div></li><li class="li1"><div class="de1">programs) then notmuch will do its best to detect those and ignore them.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">If you already have your email being delivered to directories in either</div></li><li class="li1"><div class="de1">maildir or mh format, then that's perfect. Mail storage that uses mbox</div></li><li class="li1"><div class="de1">format, (where one mbox file contains many messages), will not work with</div></li><li class="li1"><div class="de1">notmuch. If that's how your mail is currently stored, we recommend you</div></li><li class="li1"><div class="de1">first convert it to maildir format with a utility such as mb2md. You can</div></li><li class="li1"><div class="de1">continue configuring notmuch now, but be sure to complete the conversion</div></li><li class="li1"><div class="de1">before you run &quot;notmuch new&quot; for the first time.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Your full name []: alumne</div></li><li class="li1"><div class="de1">Your primary email address [alumne@server.ioc.cat.ioc.cat]: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Additional email address [Press 'Enter' if none]: </div></li><li class="li1"><div class="de1">Top-level directory of your email archive [/home/alumne/mail]: /home/alumne/Maildir</div></li><li class="li1"><div class="de1">Tags to apply to all new messages (separated by spaces) [unread inbox]: </div></li><li class="li1"><div class="de1">Tags to exclude when searching messages (separated by spaces) [deleted spam]: </div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Notmuch is now configured, and the configuration settings are saved in</div></li><li class="li1"><div class="de1">a file in your home directory named .notmuch-config . If you'd like to</div></li><li class="li1"><div class="de1">change the configuration in the future, you can either edit that file</div></li><li class="li1"><div class="de1">directly or run &quot;notmuch setup&quot;.  To choose an alternate configuration</div></li><li class="li1"><div class="de1">location, set ${NOTMUCH_CONFIG}.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">The next step is to run &quot;notmuch new&quot; which will create a database</div></li><li class="li1"><div class="de1">that indexes all of your mail. Depending on the amount of mail you have</div></li><li class="li1"><div class="de1">the initial indexing process can take a long time, so expect that.</div></li><li class="li1"><div class="de1">Also, the resulting database will require roughly the same amount of</div></li><li class="li1"><div class="de1">storage space as your current collection of email. So please ensure you</div></li><li class="li1"><div class="de1">have sufficient storage space available now.</div></li></ol></pre>

<p>
Al final de les instruccions, ens indica el següent pas, que és crear la base de dades pròpia que indexa tots els correus:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">$ notmuch new</div></li><li class="li1"><div class="de1">Found 1 total files (that's not much mail).</div></li><li class="li1"><div class="de1">Processed 1 file in almost no time.</div></li><li class="li1"><div class="de1">Added 1 new message to the database.</div></li></ol></pre>

<p>
Comprovem que s’ha creat i que tot està configurat:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">$ notmuch</div></li><li class="li1"><div class="de1">Notmuch is configured and appears to have a database. Excellent!</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">At this point you can start exploring the functionality of notmuch by</div></li><li class="li1"><div class="de1">using commands such as:</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	notmuch search tag:inbox</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	notmuch search to:&quot;alumne&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	notmuch search from:&quot;alumne@server.ioc.cat&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">	notmuch search subject:&quot;my favorite things&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">See &quot;notmuch help search&quot; for more details.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">You can also use &quot;notmuch show&quot; with any of the thread IDs resulting</div></li><li class="li1"><div class="de1">from a search. Finally, you may want to explore using a more sophisticated</div></li><li class="li1"><div class="de1">interface to notmuch such as the emacs interface implemented in notmuch.el</div></li><li class="li1"><div class="de1">or any other interface described at https://notmuchmail.org</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">And don't forget to run &quot;notmuch new&quot; whenever new mail arrives.</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Have fun, and may your inbox never have much mail.</div></li></ol></pre>

<p>
Finalment comprovem el correu que tenim a l’<em>inbox</em>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">$ notmuch search tag:inbox</div></li><li class="li1"><div class="de1">thread:0000000000000001 54 mins. ago [1/1] root; Prova Postfix (inbox)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">$ notmuch show Postfix</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">message{ id:20191001132900.AFDA27942@server.ioc.cat depth:0 match:1 excluded:0 filename:/home/alumne/Maildir/cur/1569936540.V801I4a166M737765.server.ioc.cat:2,S</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">header{</div></li><li class="li1"><div class="de1">root@server.ioc.cat (root) (Today 15:29) (inbox)</div></li><li class="li1"><div class="de1">Subject: Prova Postfix</div></li><li class="li1"><div class="de1">From: root &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">To: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Date: Tue, 01 Oct 2019 15:29:00 +0200</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">header}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">body{</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">part{ ID: 1, Content-type: text/plain</div></li><li class="li1"><div class="de1">Correu de prova amb Postfix</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">part}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">body}</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">message}</div></li></ol></pre>

<p>
<strong>4. Accés remot al correu amb POP mitjançant el programari Courier</strong>
</p>

<p>
Instal·lem el servidor de POP3 Courier, però primer esbrinem el nom del paquet:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-cache search courier | grep pop</div></li><li class="li1"><div class="de1">courier-pop - Courier mail server - POP3 server</div></li><li class="li1"><div class="de1">courier-pop-ssl - Courier mail server - POP3 over TLS [transitional]</div></li><li class="li1"><div class="de1"># apt-get install courier-pop</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  courier-authdaemon courier-authlib courier-authlib-userdb courier-base expect gnutls-bin</div></li><li class="li1"><div class="de1">  libcourier-unicode1 libfam0 libgnutls-dane0 libgnutls30 libopts25 libtcl8.6 libtk8.6</div></li><li class="li1"><div class="de1">  libunbound2 tcl-expect tcl8.6 tk8.6</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  courier-doc fam dns-root-data tcl-tclreadline</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  courier-authdaemon courier-authlib courier-authlib-userdb courier-base courier-pop expect</div></li><li class="li1"><div class="de1">  gnutls-bin libcourier-unicode1 libfam0 libgnutls-dane0 libopts25 libtcl8.6 libtk8.6</div></li><li class="li1"><div class="de1">  libunbound2 tcl-expect tcl8.6 tk8.6</div></li><li class="li1"><div class="de1">S'actualitzaran els paquets següents:</div></li><li class="li1"><div class="de1">  libgnutls30</div></li><li class="li1"><div class="de1">1 actualitzats, 17 nous a instal·lar, 0 a suprimir i 319 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 4948 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 11,9 MB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
Un cop instal·lat el servidor de POP3, comprovem el port que ha obert:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># nmap -T4 -A localhost</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Starting Nmap 7.40 ( https://nmap.org ) at 2019-10-01 16:53 CEST</div></li><li class="li1"><div class="de1">Nmap scan report for localhost (127.0.0.1)</div></li><li class="li1"><div class="de1">Host is up (0.000016s latency).</div></li><li class="li1"><div class="de1">Not shown: 995 closed ports</div></li><li class="li1"><div class="de1">PORT     STATE SERVICE  VERSION</div></li><li class="li1"><div class="de1">25/tcp   open  smtp     Postfix smtpd</div></li><li class="li1"><div class="de1">|_smtp-commands: server.ioc.cat, PIPELINING, SIZE 10240000, VRFY, ETRN, STARTTLS, ENHANCEDSTATUSCODES, 8BITMIME, DSN, SMTPUTF8, </div></li><li class="li1"><div class="de1">| ssl-cert: Subject: commonName=server.ioc.cat</div></li><li class="li1"><div class="de1">| Subject Alternative Name: DNS:server.ioc.cat</div></li><li class="li1"><div class="de1">| Not valid before: 2019-09-29T09:30:48</div></li><li class="li1"><div class="de1">|_Not valid after:  2029-09-26T09:30:48</div></li><li class="li1"><div class="de1">|_ssl-date: ERROR: Script execution failed (use -d to debug)</div></li><li class="li1"><div class="de1">110/tcp  open  pop3     Courier pop3d</div></li><li class="li1"><div class="de1">|_ssl-date: 2019-10-01T14:54:32+00:00; -1m05s from scanner time.</div></li><li class="li1"><div class="de1">995/tcp  open  ssl/pop3 Courier pop3d</div></li><li class="li1"><div class="de1">|_pop3-capabilities: PIPELINING USER LOGIN-DELAY(10) TOP IMPLEMENTATION(Courier Mail Server) UIDL</div></li><li class="li1"><div class="de1">| ssl-cert: Subject: commonName=localhost/organizationName=Courier Mail Server/stateOrProvinceName=NY/countryName=US</div></li><li class="li1"><div class="de1">| Subject Alternative Name: email:postmaster@example.com</div></li><li class="li1"><div class="de1">| Not valid before: 2019-10-01T14:45:24</div></li><li class="li1"><div class="de1">|_Not valid after:  2020-09-30T14:45:24</div></li><li class="li1"><div class="de1">|_ssl-date: 2019-10-01T14:55:22+00:00; -14s from scanner time.</div></li><li class="li1"><div class="de1">Device type: general purpose</div></li><li class="li1"><div class="de1">Running: Linux 3.X|4.X</div></li><li class="li1"><div class="de1">OS CPE: cpe:/o:linux:linux_kernel:3 cpe:/o:linux:linux_kernel:4</div></li><li class="li1"><div class="de1">OS details: Linux 3.8 - 4.6</div></li><li class="li1"><div class="de1">Network Distance: 0 hops</div></li><li class="li1"><div class="de1">Service Info: Host:  server.ioc.cat</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Host script results:</div></li><li class="li1"><div class="de1">|_clock-skew: mean: -39s, deviation: 36s, median: -1m05s</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</div></li><li class="li1"><div class="de1">Nmap done: 1 IP address (1 host up) scanned in 157.94 seconds</div></li></ol></pre>

<p>
Observem que està escoltant als ports de POP, tant el segur (995) com l’insegur (110).
</p>

<p>
Comprovem amb mutt que podem recuperar el correu:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># mutt -f pop://alumne@server.ioc.cat</div></li></ol></pre>

<p>
Primer ens demana acceptar un certificat i seguidament la contrasenya:
</p>

<p>
<div class="imgelem">
<img src="../media/mutt-pop1.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-pop2.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-pop3.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/mutt-pop4.png" alt="" /></div>

</p>

<p>
Per acabar, instal·lem i configurem un client de correu gràfic. Per exemple, <strong>Sylpheed</strong>:
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># apt-get install sylpheed</div></li><li class="li1"><div class="de1">S'està llegint la llista de paquets… Fet </div></li><li class="li1"><div class="de1">S'està construint l'arbre de dependències       </div></li><li class="li1"><div class="de1">S'està llegint la informació de l'estat… Fet</div></li><li class="li1"><div class="de1">S'instal·laran els següents paquets extres:</div></li><li class="li1"><div class="de1">  libcompfaceg1 libgtkspell0 libpisock9 pinentry-gtk2 sylpheed-i18n</div></li><li class="li1"><div class="de1">Paquets suggerits:</div></li><li class="li1"><div class="de1">  jpilot pilot-link kpilot gnome-pilot evolution claws-mail pinentry-doc sylpheed-doc</div></li><li class="li1"><div class="de1">  claws-mail-tools bogofilter bsfilter curl</div></li><li class="li1"><div class="de1">S'instal·laran els paquets NOUS següents:</div></li><li class="li1"><div class="de1">  libcompfaceg1 libgtkspell0 libpisock9 pinentry-gtk2 sylpheed sylpheed-i18n</div></li><li class="li1"><div class="de1">0 actualitzats, 6 nous a instal·lar, 0 a suprimir i 319 no actualitzats.</div></li><li class="li1"><div class="de1">S'ha d'obtenir 2068 kB d'arxius.</div></li><li class="li1"><div class="de1">Després d'aquesta operació s'empraran 8086 kB d'espai en disc addicional.</div></li><li class="li1"><div class="de1">Voleu continuar? [S/n] </div></li></ol></pre>

<p>
Anem a <em>configuració</em>, <em>crea un nou compte</em>, <em>POP3</em>:
</p>

<p>
<div class="imgelem">
<img src="../media/sylpheed1.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/sylpheed2.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/sylpheed3.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/sylpheed4.png" alt="" /></div>

</p>

<p>
<div class="imgelem">
<img src="../media/sylpheed5.png" alt="" /></div>

</p>

<p>
Si dóna un error d’escriptura en baixar-se el correu, pot ser per que no s’ha creat la carpeta on baixar-lo. Cal anar al menú <em>File</em>, <em>Mailbox</em> o <em>Add mailbox</em>.
</p>

<p>
<div class="imgelem">
<img src="../media/sylpheed6.png" alt="" /></div>

</p>

<p>
<strong>5</strong>. Proves avançades amb el <strong>telnet</strong>.
</p>

<p>
Finalment, mostrem el correu enviat amb telnet obrint el port POP versió 3. El protocol POP3 està especificat al <acronym title="Request for Comments">RFC</acronym> 1939. Als apartats 4, 5, 6 i 7 hi ha la part relativa a les comandes POP. En el següent exemple s’han fet servir les comandes: user, pass, list, retr i quit.
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1"># telnet localhost pop3</div></li><li class="li1"><div class="de1">Trying 127.0.0.1...</div></li><li class="li1"><div class="de1">Connected to localhost.</div></li><li class="li1"><div class="de1">Escape character is '^]'.</div></li><li class="li1"><div class="de1">+OK Hello there.</div></li><li class="li1"><div class="de1">user alumne</div></li><li class="li1"><div class="de1">+OK Password required.</div></li><li class="li1"><div class="de1">pass alumne</div></li><li class="li1"><div class="de1">+OK logged in.</div></li><li class="li1"><div class="de1">list</div></li><li class="li1"><div class="de1">+OK POP3 clients that break here, they violate STD53.</div></li><li class="li1"><div class="de1">1 477</div></li><li class="li1"><div class="de1">.</div></li><li class="li1"><div class="de1">retr 1</div></li><li class="li1"><div class="de1">+OK 477 octets follow.</div></li><li class="li1"><div class="de1">Return-Path: &lt;root@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">X-Original-To: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Delivered-To: alumne@server.ioc.cat</div></li><li class="li1"><div class="de1">Received: by server.ioc.cat (Postfix, from userid 0)</div></li><li class="li1"><div class="de1">	id AFDA27942; Tue,  1 Oct 2019 15:29:00 +0200 (CEST)</div></li><li class="li1"><div class="de1">Subject: Prova Postfix</div></li><li class="li1"><div class="de1">To: &lt;alumne@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">X-Mailer: mail (GNU Mailutils 3.1.1)</div></li><li class="li1"><div class="de1">Message-Id: &lt;20191001132900.AFDA27942@server.ioc.cat&gt;</div></li><li class="li1"><div class="de1">Date: Tue,  1 Oct 2019 15:29:00 +0200 (CEST)</div></li><li class="li1"><div class="de1">From: root@server.ioc.cat (root)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">Correu de prova amb Postfix</div></li><li class="li1"><div class="de1">.</div></li><li class="li1"><div class="de1">quit</div></li><li class="li1"><div class="de1">+OK Bye-bye.</div></li><li class="li1"><div class="de1">Connection closed by foreign host.</div></li></ol></pre>

<p>
<strong>Referències</strong>
</p>

<p>
<a href="http://www.postfix.org/" class="urlextern" title="http://www.postfix.org/"  rel="nofollow">PostFix</a>
</p>

<p>
<a href="http://www.courier-mta.org/" class="urlextern" title="http://www.courier-mta.org/"  rel="nofollow">Courier-MTA</a>
</p>

<p>
<a href="https://notmuchmail.org/" class="urlextern" title="https://notmuchmail.org/"  rel="nofollow">NotMuchMail</a>
</p>

<p>
<a href="https://sylpheed.sraoss.jp/en/" class="urlextern" title="https://sylpheed.sraoss.jp/en/"  rel="nofollow">Sylpheed</a>
</p>
</div><input class="btn_solution3" type="button" value="Mostra"></input></form>
</p>

</div>

<h2><a id="smtp_amb_python" >SMTP amb Python</a></h2>
<div class="level2">

<p>
Aquesta és una activitat avançada pel que fa als objectius principals del mòdul. L’objectiu d’aquesta activitat és practicar la programació de correu SMTP amb el llenguatge de programació Python.
</p>

<p>
Utilitzant un llenguatge d’alt nivell i fàcil d’utilitzar, com per exemple Python, programeu l’enviament de correu i la simulació de sessions SMTP utilitzant les llibreries pertinents de Python.
</p>
<ol>
<li class="level1"><div class="li"> Creeu un programa que envia un correu electrònic imitant una sessió Telnet a un servidor SMTP.</div>
</li>
<li class="level1"><div class="li"> Creeu un programa que envia una carta (un document de text extern en un fitxer) a una llista de destinataris (llista externa en un altre fitxer de text). Cal usar la biblioteca de Python smtplib.</div>
</li>
<li class="level1"><div class="li"> Creeu un programa Python que envia correu multipart i que recorre les diverses parts d’un correu usant la biblioteca MIME de Python.</div>
</li>
</ol>

<p>
<form action=""><div class="solution ioccontent">
<p>
<strong>1. Enviament un correu electrònic imitant una sessió Telnet a un servidor SMTP</strong>
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">#fitxer: Activitat_ASX_uf3_na1_smtp_python-01.py</div></li><li class="li1"><div class="de1">#! /usr/bin/python</div></li><li class="li1"><div class="de1"># -*- coding: utf-8-*-</div></li><li class="li1"><div class="de1"># imitar una conversa telnet smtp amb sockets</div></li><li class="li1"><div class="de1"># 27/01/2012</div></li><li class="li1"><div class="de1"># @edt</div></li><li class="li1"><div class="de1"># -------------------------------------------------------------------</div></li><li class="li1"><div class="de1"># Crear un programa que envia un email imitant una sessió telnet a</div></li><li class="li1"><div class="de1"># un servidor SMTP.</div></li><li class="li1"><div class="de1"># ioc-m08-uf3-a1 smtp</div></li><li class="li1"><div class="de1"># -------------------------------------------------------------------</div></li><li class="li1"><div class="de1">import socket</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">mfrom=&quot;MAIL FROM: unknown@kaos.sex\n&quot;</div></li><li class="li1"><div class="de1">to_01=&quot;RCPT TO: pere\n&quot;</div></li><li class="li1"><div class="de1">to_02=&quot;RCPT TO: root@localhost.localdomain\n&quot;</div></li><li class="li1"><div class="de1">to_03=&quot;RCPT TO: batman@gotham.city\n&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">capcaleres=&quot;&quot;&quot;\</div></li><li class="li1"><div class="de1">subject: missatge de prova per imitar conversa smtp</div></li><li class="li1"><div class="de1">Date: Fri, 27 Jan 2012 09:54:15 +0100</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">From: barakObama@whitehouse.us&quot;&quot;&quot;</div></li><li class="li1"><div class="de1">crlf=&quot;\n&quot;</div></li><li class="li1"><div class="de1">text=&quot;&quot;&quot;\</div></li><li class="li1"><div class="de1">aquest és un missatge de prova enviat per unknown, verificar</div></li><li class="li1"><div class="de1">si realment el from és aquest o en Barak.</div></li><li class="li1"><div class="de1">Els destinataris són: pere, root i batman.</div></li><li class="li1"><div class="de1">bye bye</div></li><li class="li1"><div class="de1">.\n&quot;&quot;&quot;</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">to=to_01+to_02+to_02</div></li><li class="li1"><div class="de1">msg=capcaleres+crlf+text</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">print mfrom</div></li><li class="li1"><div class="de1">print to</div></li><li class="li1"><div class="de1">print msg</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">HOST = ''</div></li><li class="li1"><div class="de1">PORT = 25</div></li><li class="li1"><div class="de1">s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</div></li><li class="li1"><div class="de1">s.connect((HOST, PORT))</div></li><li class="li1"><div class="de1">data = s.recv(1024)</div></li><li class="li1"><div class="de1">print data</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">s.send('EHLO localhost.localdomain\n')</div></li><li class="li1"><div class="de1">data = s.recv(1024)</div></li><li class="li1"><div class="de1">print data</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">s.send(mfrom)</div></li><li class="li1"><div class="de1">data = s.recv(1024)</div></li><li class="li1"><div class="de1">print data</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">s.send(to)</div></li><li class="li1"><div class="de1">data = s.recv(1024)</div></li><li class="li1"><div class="de1">print data</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">s.send('DATA\n')</div></li><li class="li1"><div class="de1">data = s.recv(1024)</div></li><li class="li1"><div class="de1">print data</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">s.send(msg)</div></li><li class="li1"><div class="de1">data = s.recv(1024)</div></li><li class="li1"><div class="de1">print data</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">s.close()</div></li><li class="li1"><div class="de1">print s</div></li></ol></pre>

<p>
<strong>2. Enviament d’una carta (un document de text extern en un fitxer) a una llista de destinataris (llista externa en un altre fitxer de text), utilitzant la biblioteca de Python smtplib</strong>
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">#fitxer: Activitat_ASX_uf3_na1_smtp_python-02.py</div></li><li class="li1"><div class="de1">#! /usr/bin/python</div></li><li class="li1"><div class="de1"># -*- coding: utf-8-*-</div></li><li class="li1"><div class="de1"># imitar una conversa telnet smtp amb sockets</div></li><li class="li1"><div class="de1"># 27/01/2012</div></li><li class="li1"><div class="de1"># @edt</div></li><li class="li1"><div class="de1"># -------------------------------------------------------------------</div></li><li class="li1"><div class="de1"># Crear un programa que envia una carta (un document de text extern </div></li><li class="li1"><div class="de1"># en un fitxer) a una llista de destinataris (llista externa en un</div></li><li class="li1"><div class="de1"># altre fitxer de text). Cal usar la biblioteca de Python smtplib.</div></li><li class="li1"><div class="de1"># ioc-m08-uf3-a1 smtp</div></li><li class="li1"><div class="de1"># -------------------------------------------------------------------</div></li><li class="li1"><div class="de1">import smtplib, sys</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">try:</div></li><li class="li1"><div class="de1">    fusuarios = open('usuaris.txt','r')</div></li><li class="li1"><div class="de1">    fmensaje = open('missatge.txt','r')</div></li><li class="li1"><div class="de1">except:</div></li><li class="li1"><div class="de1">    print &quot;No es poden llegir els fitxers&quot;</div></li><li class="li1"><div class="de1">    sys.exit(0)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"># Obtenir el missatge a enviar</div></li><li class="li1"><div class="de1">mensaje = fmensaje.read()</div></li><li class="li1"><div class="de1"># Adreça origen</div></li><li class="li1"><div class="de1">de = raw_input(&quot;From: &quot;) </div></li><li class="li1"><div class="de1">for email in fusuarios:</div></li><li class="li1"><div class="de1">    to = email</div></li><li class="li1"><div class="de1">    server = smtplib.SMTP('localhost')</div></li><li class="li1"><div class="de1">    server.sendmail(de, to, mensaje)</div></li><li class="li1"><div class="de1">server.quit()</div></li></ol></pre>

<p>
<strong>3. Enviament de correu multipart que recorre les diverses parts d’un correu usant la biblioteca MIME de Python</strong>
</p>
<pre class="code bash"><ol><li class="li1"><div class="de1">#fitxer: Activitat_ASX_uf3_na1_smtp_python-03.py</div></li><li class="li1"><div class="de1">#! /usr/bin/python</div></li><li class="li1"><div class="de1"># -*- coding: utf-8-*-</div></li><li class="li1"><div class="de1"># Obrir els pdf i jpeg adjunts d'un missatge mime</div></li><li class="li1"><div class="de1"># 27/01/2012</div></li><li class="li1"><div class="de1"># @edt</div></li><li class="li1"><div class="de1"># -------------------------------------------------------------------</div></li><li class="li1"><div class="de1"># Crear un programa Python que envia correu multipart i que recorre</div></li><li class="li1"><div class="de1"># les diverses parts d’un correu usant la biblioteca mime de Python.</div></li><li class="li1"><div class="de1"># ioc-m08-uf3-a1 smtp</div></li><li class="li1"><div class="de1"># -------------------------------------------------------------------</div></li><li class="li1"><div class="de1">import sys, mailbox, email, mimetypes, subprocess</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">def desar_pdf(part,n):</div></li><li class="li1"><div class="de1">    print &quot;desant pdf&quot;</div></li><li class="li1"><div class="de1">    file = &quot;./attach-%d%s&quot; % (n, &quot;.pdf&quot;)    </div></li><li class="li1"><div class="de1">    fit = open (file, &quot;wb&quot;)</div></li><li class="li1"><div class="de1">    fit.write(part.get_payload(decode=True))</div></li><li class="li1"><div class="de1">    fit.close()</div></li><li class="li1"><div class="de1">    popen = subprocess.Popen([&quot;/usr/bin/evince&quot;,file])</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">def desar_jpeg(part,n):</div></li><li class="li1"><div class="de1">    print &quot;desant jpeg&quot;</div></li><li class="li1"><div class="de1">    file = &quot;./attach-%d%s&quot; % (n, &quot;.jpeg&quot;)  </div></li><li class="li1"><div class="de1">    fit = open (file, &quot;wb&quot;)</div></li><li class="li1"><div class="de1">    fit.write(part.get_payload(decode=True))</div></li><li class="li1"><div class="de1">    fit.close()</div></li><li class="li1"><div class="de1">    popen = subprocess.Popen([&quot;/usr/bin/firefox&quot;,file])</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1">nomFitxer = 'pere.mbox1'</div></li><li class="li1"><div class="de1">bustia = mailbox.mbox(nomFitxer)</div></li><li class="li1"><div class="de1">numMissatges = bustia.__len__()</div></li><li class="li1"><div class="de1"># message&lt;---email.message_from_string(string)</div></li><li class="li1"><div class="de1">&nbsp;</div></li><li class="li1"><div class="de1"># Iterar per a cada missatge</div></li><li class="li1"><div class="de1">n = 0</div></li><li class="li1"><div class="de1">for num in range(numMissatges):</div></li><li class="li1"><div class="de1">    # processar el  missatge </div></li><li class="li1"><div class="de1">    msg = bustia.get_message(num)  </div></li><li class="li1"><div class="de1">    # iterar per les parts del missatges    </div></li><li class="li1"><div class="de1">    for part in msg.walk():</div></li><li class="li1"><div class="de1">        main = part.get_content_maintype()</div></li><li class="li1"><div class="de1">        sub = part.get_content_subtype()</div></li><li class="li1"><div class="de1">        tipus = part.get_content_type()</div></li><li class="li1"><div class="de1">        print mimetypes.guess_extension(tipus)</div></li><li class="li1"><div class="de1">        if sub == &quot;pdf&quot;:</div></li><li class="li1"><div class="de1">            n = n + 1</div></li><li class="li1"><div class="de1">            desar_pdf(part,n)</div></li><li class="li1"><div class="de1">        if sub == &quot;jpeg&quot;:</div></li><li class="li1"><div class="de1">            n = n + 1</div></li><li class="li1"><div class="de1">            desar_jpeg(part,n)</div></li><li class="li1"><div class="de1">    print</div></li><li class="li1"><div class="de1">bustia.close()</div></li><li class="li1"><div class="de1">sys.exit(0)</div></li></ol></pre>

<p>
Podeu descarregar els fitxers anteriors al següent enllaç:
</p>

<p>
<div class="mediaf filezip"><div class="mediacontent"><a href="../media/activitat_asx_uf3_na1_smtp_python.zip">Solucions a l&#039;activitat en Python</a><span> ( 2.2 KB )</span></div></div>
</p>
</div><input class="btn_solution3" type="button" value="Mostra"></input></form>
</p>

</div>

	 </article>
     <div class="pnpage">
      <div class="left-corner"></div>
      <div id="prevpage">Anar a la p&agrave;gina anterior:<br /><a href="../../../WebContent/u3/a1/continguts.html">Instal·lació i administració del servei de correu electrònic</a></div>
      <div id="nextpage">Anar a la p&agrave;gina seg&uuml;ent:<br /><a href="../../../WebContent/u3/a1/exercicis.html">Exercicis</a></div>
      <div class="right-corner"></div>
     </div>
    </div>
    <footer class="footer">
      <div><small>Aquest document està subjecte a una llicència oberta de Creative Commons, es reserva el dret de reconeixement de l'autoria, d'exigir que no se'n faci cap mena d'ús comercial. Si altereu o transformeu aquesta obra, o en genereu obres derivades, només podeu distribuir l'obra generada amb una llicència idèntica a aquesta.</small></div>
    </footer>
 </div>
 <div id="back_preview" class="hidden"></div>
 <div id="preview" class="hidden">
  <div class="prevcontent"></div>
 </div>
 <div id="help-tooltips">
  <div id="help-toc" class="hidden tooltip"><span>Taula de continguts:</span> Ofereix una vista general de l&#39;estructura del m&ograve;dul, que us facilitar&agrave; la navegaci&oacute; a trav&eacute;s dels seus continguts.<span class="arrow-left"></span></div> 
  <div id="help-settings" class="hidden tooltip"><span>Opcions de format:</span> Permet configurar el format de lectura a partir de les vostres prefer&egrave;ncies, modificant la mida de la lletra, el color del fons, l&#39;amplada de la p&agrave;gina o l&#39;ocultaci&oacute; dels continguts complementaris, entre d&#39;altres.<span class="arrow-left"></span></div>
  <div id="help-printer" class="hidden tooltip"><span>Imprimir:</span>  Envia el contingut seleccionat a la impressora.<span class="arrow-left"></span></div>
  <div id="help-favorites" class="hidden tooltip"><span>Prefereits:</span> Permet desar aquelles parts del contingut a les que us interessi accedir en un moment posterior; us permetr&agrave; anar creant un repositori personalitzat de les seccions que considereu m&eacute;s rellevants. Un cop l&#39;hageu començat a fer servir se us mostrar&agrave; a sota un comptador que us informar&agrave; del nombre de preferits que s&#39;hagin emmagatzemat fins al moment.<span class="arrow-left"></span></div>
  <div id="help-favcounter" class="hidden tooltip"><span>Comptador i llistat de preferits:</span> Indica el nombre de preferits que s&#39;han desat fins el moment; clicant damunt seu accedireu al llistat de preferits, i a trav&eacute;s d&#39;aquest podreu accedir directament als continguts que hageu emmagatzemat.<span class="arrow-left"></span></div>
  <div id="help-help_icon" class="hidden tooltip"><span>Ajuda:</span> Aquesta opci&oacute; activa la informaci&oacute; de les funcionalitats del web tot situant el punter del ratol&iacute; al damunt dels diferents &iacute;tems.<span class="arrow-left"></span></div>
  <div id="help-sidebar-hide" class="hidden tooltip"><span>Mostrar/Ocultar barra lateral:</span>  Deshabilita la barra d&#39;opcions, permetent la seva recuperaci&oacute; quan es desitgi.<span class="arrow-left"></span></div>
  <div id="help-search" class="hidden tooltip"><span>Cerca:</span>  Introdu&iuml;u les paraules clau sobre aquells conceptes que desitgeu localitzar en els continguts del m&ograve;dul. Tamb&eacute; podeu excloure un terme de la cerca tot afegint-hi el signe &#8220;-&#8221; al davant.<span class="arrow-top"></span></div>
  <div id="help-header" class="hidden tooltip"><span>Cap&ccedil;alera:</span>  Indica l&#39;apartat o secci&oacute; que es mostra en pantalla. Tingueu present que les capçaleres de segon, tercer i quart nivell tamb&eacute; es poden desar com a marcadors.<span class="arrow-left"></span></div>
</div> 
</body>
</html>
